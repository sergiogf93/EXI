//
//function ExiController(){
//	this.init();
//};
//
//ExiController.prototype.init = function(){
//	function setPageBackground() {
//
//	}
//	function notFound() {
//
//	}
//
//	function loadNavigationPanel(listView){
//		/** Cleaning up navigation panel **/
//		EXI.clearNavigationPanel();
//		EXI.setLoadingNavigationPanel(true);
//		
//		/** Load data data **/
//		var adapter = new DataAdapter();
//		adapter.onSuccess.attach(function(sender, data) {
//			/** Load panel **/
//			EXI.addNavigationPanel(listView);
//			/** Load data **/
//			listView.store.loadData(data);
//			EXI.setLoadingNavigationPanel(false);
//		});
//		
//		/** Handle error **/
//		adapter.onError.attach(function(sender, data) {
//			EXI.setLoadingNavigationPanel(false);
//		});
//		return adapter;
//	}
//	
//	
//	/** Welcome Page **/
//	Path.map("#/").to(function() {}).enter(setPageBackground);
//	
//	
//	/** 
//	 * Loading navigation panel
//	 *  
//	 * #/session/nav
//	 * #/experiment/nav
//	 * #/macromolecule/nav
//	 * 
//	 * */
//	Path.map("#/:navigation/nav").to(function() {
//		/** Session navigation **/
//		if (this.params['navigation'] == "session") {
//			var listView = new SessionListView();
//			/** When selected move to hash **/
//			listView.onSelect.attach(function(sender, selected) {
//				location.hash = "/session/nav/" + selected[0].sessionId + "/session";
//			});
//			var adapter = loadNavigationPanel(listView);
//			adapter.getSessions();
//		}
//
//		if (this.params['navigation'] == "shipping") {
//			var listView = new ShippingListView();
//			/** When selected move to hash **/
//			listView.onSelect.attach(function(sender, selected) {
//				location.hash = "/shipping/" + selected[0].shippingId + "/main";
//			});
//			var adapter = loadNavigationPanel(listView);
//			adapter.getShippings();
//		}
//		
//		if (this.params['navigation'] == "experiment") {
//			var listView = new ExperimentListView();
//			/** When selected move to hash **/
//			listView.onSelect.attach(function(sender, selected) {
//				location.hash = "/experiment/experimentId/" + selected[0].experimentId + "/main";
//			});
//			var adapter = loadNavigationPanel(listView);
//			adapter.getExperiments();
//		}
//		
//		if (this.params['navigation'] == "template") {
//			var listView = new TemplateListView();
//			/** When selected move to hash **/
//			listView.onSelect.attach(function(sender, selected) {
//				location.hash = "/experiment/templateId/" + selected[0].experimentId + "/main";
//			});
//			var adapter = loadNavigationPanel(listView);
//			adapter.getByExperimentByKey("experimentType", "TEMPLATE");
//		}
//		
//
//		if (this.params['navigation'] == "macromolecule") {
//			alert("not implemented yet");
//		}
//		
//	}).enter(setPageBackground);
//
//	/** Loading a single session on the navigation panel **/
//	Path.map("#/session/nav/:sessionId/session").to(function() {
//		var listView = new ExperimentListView();
//		/** When selected move to hash **/
//		listView.onSelect.attach(function(sender, selected) {
//			location.hash = "/experiment/experimentId/" + selected[0].experimentId + "/main";
//		});
//		var adapter = loadNavigationPanel(listView);
//		adapter.getExperimentsBySessionId(this.params['sessionId']);
//		
//	}).enter(setPageBackground);
//
//	Path.map("#/experiment/experimentId/:experimentId/main").to(function() {
//			var mainView = new ExperimentMainView();
//			EXI.addMainPanel(mainView);
//			mainView.load(this.params['experimentId']);
//					/** Selecting data collections from experiment **/
//			mainView.onSelect.attach(function(sender, element) {
//					EXI.localExtorage.selectedSubtractionsManager.append(element);
//			});
//			mainView.onDeselect.attach(function(sender, element) {
//					EXI.localExtorage.selectedSubtractionsManager.remove(element);
//			});
//
//	}).enter(setPageBackground);
//	
//	
//	/** Loading Experiments **/
//	Path.map("#/experiment/:key/:value/main").to(function() {
//		var adapter = new DataAdapter();
//		EXI.setLoadingMainPanel();
//		adapter.onSuccess.attach(function(sender, data) {
//			EXI.setLoadingMainPanel(false);
//			if (data != null) {
//				if (data.length > 0) {
//					var mainView = null;
//					if (data[0].experimentType == "STATIC") {
//						mainView = new ExperimentMainView();
//						
//					}
//					if (data[0].experimentType == "HPLC") {
//						mainView = new HPLCMainView();
//					}
//					
//					if (data[0].experimentType == "TEMPLATE") {
//						mainView = new TemplateMainView();
//					}
//					
//					EXI.addMainPanel(mainView);
//					mainView.load(data);
//					/** Selecting data collections from experiment **/
//					mainView.onSelect.attach(function(sender, element) {
//						EXI.localExtorage.selectedSubtractionsManager.append(element);
//					});
//					mainView.onDeselect.attach(function(sender, element) {
//						EXI.localExtorage.selectedSubtractionsManager.remove(element);
//					});
//					
//				}
//			}
//		});
//		if ((this.params['key'] == "experimentId")||(this.params['key'] == "templateId")){
//			adapter.getByExperimentId([this.params['value']]);
//		}
//		else{
//			adapter.getByExperimentByKey(this.params['key'], this.params['value']);
//		}
//		
//
//	}).enter(setPageBackground);
//
//	Path.map("#/tool/crysol/main").to(function() {
//		var mainView = new CrysolMainView();
//		EXI.addMainPanel(mainView);
//		mainView.load();
//	}).enter(setPageBackground);
//
//	
//	Path.map("#/tool/subtraction/main").to(function() {
//		var mainView = new SubtractionMainView();
//		EXI.addMainPanel(mainView);
//		mainView.load();
//	}).enter(setPageBackground);
//	
//	Path.map("#/datacollection/:key/:value/main").to(function() {
//		EXI.setLoadingMainPanel();
//		var adapter = new DataAdapter();
//		adapter.onSuccess.attach(function(sender, data) {
//			var mainView = new DataCollectionMainView();
//			EXI.addMainPanel(mainView);
//			mainView.load(data);
//			EXI.setLoadingMainPanel(false);
//			/** Selecting data collections from experiment **/
//			mainView.onSelect.attach(function(sender, element) {
//				EXI.localExtorage.selectedSubtractionsManager.append(element);
//			});
//			mainView.onDeselect.attach(function(sender, element) {
//				EXI.localExtorage.selectedSubtractionsManager.remove(element);
//			});
//		});
//		adapter.getDataCollectionsByKey(this.params['key'], this.params['value']);
//
//	}).enter(setPageBackground);
//
//	
//	Path.map("#/datacollection/:key/:value/primaryviewer").to(function() {
//		var adapter = new DataAdapter();
//		adapter.onSuccess.attach(function(sender, data) {
//			var primaryMainView = new PrimaryDataMainView();
//			EXI.addMainPanel(primaryMainView);
//			primaryMainView.load(data);
//
//		});
//		adapter.getDataCollectionsByKey(this.params['key'], this.params['value']);
//	}).enter(setPageBackground);
//
//	Path.map("#/datacollection/:key/:value/merge").to(function() {
//		var adapter = new DataAdapter();
//		adapter.onSuccess.attach(function(sender, data) {
//			var primaryMainView = new MergeMainView();
//			EXI.addMainPanel(primaryMainView);
//			primaryMainView.load(data);
//
//		});
//		adapter.getDataCollectionsByKey(this.params['key'], this.params['value']);
//	}).enter(setPageBackground);
//
//	Path.map("#/project/:projectId/run/:runId/main").to(function() {
//		var projectId = this.params['projectId'];
//		var runId = this.params['runId'];
//		var exidataAdapter = new ExiDataAdapter();
//		exidataAdapter.onSuccess.attach(function(sender, runs) {
//			for (var i = 0; i < runs.length; i++) {
//				if (runs[i].internalId == runId) {
//					var main = new RunMainView();
//					EXI.addMainPanel(main);
//					main.load(runs[i]);
//				}
//			}
//		});
//		exidataAdapter.getRuns(projectId);
//	}).enter(setPageBackground);
//
//	
//	Path.map("#/prepare/designer/main").to(function() {
//		var mainView = new ExperimentDesignerMainView();
//		EXI.addMainPanel(mainView);
//		mainView.load();
//	}).enter(setPageBackground);
//	
//	
//	Path.map("#/prepare/buffer/main").to(function() {
//		var mainView = new BufferMainView();
//		EXI.addMainPanel(mainView);
//		mainView.load();
//	}).enter(setPageBackground);
//	
//	
//	Path.map("#/shipping/:shippingId/main").to(function() {
//		var mainView = new ShippingMainView();
//		var shippindId = this.params['shippingId'];
//		EXI.addMainPanel(mainView);
//		mainView.load(shippindId);
//	}).enter(setPageBackground);
//	
//	
//	Path.map("#/prepare/stocksolution/main").to(function() {
//		var mainView = new StockSolutionMainView();
//		EXI.addMainPanel(mainView);
//		mainView.load();
//	}).enter(setPageBackground);
//	
//	
//	Path.map("#/prepare/macromolecule/main").to(function() {
//		var mainView = new MacromoleculeMainView();
//		EXI.addMainPanel(mainView);
//		mainView.load();
//	}).enter(setPageBackground);
//	
//	Path.map("#/prepare/templates/main").to(function() {
//		var mainView = new ExperimentDesignerMainView();
//		EXI.addMainPanel(mainView);
//		mainView.load();
//	}).enter(setPageBackground);
//	
//	Path.map("#/prepare/designer").to(function() {
//		var wizardWidget = new WizardWidget({
//			windowMode : true,
//			width : 1200
//		});
//
//		wizardWidget.onFinished.attach(function(sender, result) {
//			var adapter = new DataAdapter();
//			wizardWidget.window.close();
//			EXI.setLoading();
//			adapter.onSuccess.attach(function(sender, experiment) {
//				location.hash = "/experiment/experimentId/" + experiment.experimentId + "/main";
//			});
//			wizardWidget.current.setLoading("ISPyB: Creating experiment");
//			
//			adapter.saveTemplate(result.name, "comments", result.data);
//		});
//
//		var manager = new ProposalUpdater(); 
//		manager.onSuccess.attach(function(sender, proposals){
//			wizardWidget.draw(this.targetId, new MeasurementCreatorStepWizardForm(ProposalManager.getMacromolecules(), ProposalManager.getBuffers()));
//		});
//		manager.get();
//		
//	}).enter(setPageBackground);
//	
//	
//	Path.map("#/welcome/:user/main").to(function() {
//		var user = this.params['shippingId'];
//		var mainView = new WelcomeMainView();
//		EXI.addMainPanel(mainView);
//		mainView.load(user);
//	}).enter(setPageBackground);
//	
//	
//	
//	Path.map("#/login").to(function() {
//		var _this = this;
//		
//		
//		EXI.authenticationForm.show();
//		return;
//		var authenticationForm = new AuthenticationForm();
//		authenticationForm.onAuthenticate.attach(function(sender, args){
//			var authenticationManager = new AuthenticationManager();
//			authenticationManager.onSuccess.attach(function(sender, args){
//				/** This user has been authenticated **/
////				EXI.localExtorage.tokenManager.addToken(args.user, args.token, args.url);
////				debugger
//				EXI.credentialManager.addCredential(args.user, args.roles, args.token, args.url);
////				EXI.mainMenu.addLoggin(args.user,  args.url);
//				authenticationForm.window.close();
//				
//				/** load proposals **/
//				location.hash = "/welcome/" + args.user + "/main";
//				
//				/** Loading projects **/
////				var exidataAdapter = new ExiDataAdapter();
////				exidataAdapter.onSuccess.attach(function(sender, projects){
////					EXI.localExtorage.userManager.setProjects(projects);
////				});
////				exidataAdapter.getUser();
//				
//				/** Loading proposal **/
////				new ProposalUpdater().get(true);
//				
////				window.location.href = 'main.html';
//				
//			});
//			
//			authenticationManager.login(args.user, args.password, args.site);
//			
//		});
//		authenticationForm.show();
//		
//	}).enter(setPageBackground);
//	
//	
//	Path.map("#/logout").to(function() {
//		EXI.credentialManager.logout();
////		if (EXI.localExtorage){
////			EXI.localExtorage.clear();
////		}
////		if (EXI.mainMenu){
////			EXI.mainMenu.setCredentials();
////		}
//		
////		window.location.href = 'main.html';
//		
//	}).enter(setPageBackground);
//	
//	// Here we set a "root route".  You may have noticed that when you landed on this
//	// page you were automatically "redirected" to the "#/users" route.  The definition
//	// below tells PathJS to load this route automatically if one isn't provided.
//	Path.root("#/");
//
//	// The `Path.rescue()` method takes a function as an argument, and will be called when
//	// a route is activated that you have no yet defined an action for.  On this example
//	// page, you'll notice there is no defined route for the "Unicorns!?" link.  Since no
//	// route is defined, it calls this method instead.
//	Path.rescue(notFound);
//	
//	
//};

function AuthenticationManager(){
	this.onSuccess = new Event(this);
	this.onError = new Event(this);
}

/**
 * url to an ISPyB instance http://pc593.embl.fr:8080/ispyb-ws/rest
 * @param user
 * @param password
 * @param url
 */
AuthenticationManager.prototype.login = function(user, password, url){
	var _this = this;
	var fn = function onSuccess(sender, data) {
		_this.onSuccess.notify({
			user : user,
			roles : data.roles,
			token : data.token,
			url : url
	});
	};
		
	var err = function(sender, data) {
		EXI.setError("Permission denied");
		BUI.showError("Your credentials are invalid");
	};

	EXI.getDataAdapter({
		onSuccess 	: fn,
		onError 	: err,
		url			: url,
		username 	: user
		
	}).proposal.authentication.authenticate(user, password, url);
	
	
	
};

function Exi(args) {
	var _this = this;
	
	this.headerCssClass = "titlePanel";
	
	/** Active Menu **/
	this.mainMenu = new MainMenu();
	/** When user is not logged in **/
	this.anonymousMenu = null;
	/** When user is logged in **/
	this.userMenu = null;
	
	/** If false when opening a new tab it will close the already open ones **/
	this.keepTabs = false;
	
	
	this.controllers = [new ExiController(), new ProposalExiController(), new ShippingExiController()];
	
	if (args != null){
		if (args.menu != null){
			this.mainMenu = args.menu;
			this.userMenu = args.menu;
		}
		if (args.anonymousMenu != null){
			this.anonymousMenu = args.anonymousMenu;
		}
		
		if (args.headerCssClass != null){
			this.headerCssClass = args.headerCssClass;
		}
		
		if (args.controllers != null){
			for (var i = 0; i < args.controllers.length; i++) {
				this.controllers.push(args.controllers[i]);
			}
		}
	}
	/** Status bar **/
	this.mainStatusBar = new MainStatusBar();
	
	/** Proposal manager **/
	this.proposalManager = new ProposalManager();
	
	this.credentialManager = new CredentialManager();
	this.credentialManager.onLogout.attach(function(sender){
		_this.mainMenu.populateCredentialsMenu();
		_this.clearMainPanel();
		_this.clearNavigationPanel();
		_this.setAnonymousMenu();
		Ext.getCmp("navigation").collapse();
		location.hash = '/welcome';
	});
	
	
	this.credentialManager.onLogin.attach(function(sender){
		_this.mainMenu.populateCredentialsMenu();
		_this.setUserMenu();
	});
	
	this.credentialManager.onActiveProposalChanged.attach(function(sender){
		_this.mainMenu.populateCredentialsMenu();
	});
	
	/** AUTHENTICATION FORM **/
	this.authenticationForm = new AuthenticationForm();
	this.authenticationForm.onAuthenticate.attach(function(sender, args){
		var authenticationManager = new AuthenticationManager();
		authenticationManager.onSuccess.attach(function(sender, data){
			/** This user has been authenticated **/
			_this.credentialManager.addCredential(data.user, data.roles, data.token, args.site, args.exiUrl, args.properties);
			_this.authenticationForm.window.close();
			
			var credential = EXI.credentialManager.getCredentialByUserName(data.user);
			if (credential.isManager()){
				location.hash = "/welcome/manager/" + data.user + "/main";
			}
			else{
				location.hash = "/welcome/user/" + data.user + "/main";
			}
			
			/** Authenticating EXI **/
			_this.getDataAdapter().exi.offline.authenticate();
			
		});
		
		authenticationManager.login(args.user, args.password, args.site);
	});
	
	this.onAfterRender = new Event(this);
}

/**
 * This method append to args the values of the active connection: url, token and proposal
 */
Exi.prototype.appendDataAdapterParameters = function(args) {
	if (args == null){ args = {};}
	
	/** Getting credentials **/
	var connections = EXI.credentialManager.getConnections();
	/** Authentication data adapter does not need any token **/
	if (connections.length > 0){
		args.url = connections[0].url;
		args.token = connections[0].token;
		args.proposal = connections[0].proposal;
	}
	return args;	
};



Exi.prototype.getDataAdapter = function(args) {
	return new DataAdapterFactory(this.appendDataAdapterParameters(args));
};

Exi.prototype.setAnonymousMenu = function() {
	this.mainMenu = this.anonymousMenu;
	Ext.getCmp("mainMenu").removeAll();
	Ext.getCmp("mainMenu").add(EXI.mainMenu.getPanel());
};

Exi.prototype.setUserMenu = function() {
	this.mainMenu = this.userMenu;
	Ext.getCmp("mainMenu").removeAll();
	Ext.getCmp("mainMenu").add(EXI.mainMenu.getPanel());
};


Exi.prototype.loadSelected = function(selected) {
};




/**
 * Adds a new Main panel to the center panel
 * @param mainView
 */
Exi.prototype.addMainPanel = function(mainView) {
	if (!this.keepTabs){
		Ext.getCmp('main_panel').removeAll();
	}
	Ext.getCmp('main_panel').add(mainView.getPanel());
	Ext.getCmp('main_panel').setActiveTab(Ext.getCmp('main_panel').items.length - 1);
};

Exi.prototype.getSelectedDataCollections = function() {
	var selected = [];
	for (var i = 0; i < this.experimentListView.length; i++) {
		selected = selected.concat(this.experimentListView[i].getSelected());
	}
	return selected;
};

Exi.prototype.addNavigationPanel = function(listView) {
	Ext.getCmp('navigation').add(listView.getPanel());
	if (Ext.getCmp("navigation") != null){
		Ext.getCmp("navigation").expand();
	}
};

Exi.prototype.clearNavigationPanel = function() {
	Ext.getCmp('navigation').removeAll();
};

Exi.prototype.clearMainPanel = function() {
	Ext.getCmp('main_panel').removeAll();
};

Exi.prototype.setLoadingNavigationPanel = function(isLoading) {
	Ext.getCmp('navigation').setLoading(isLoading);
};

Exi.prototype.setLoadingMainPanel = function(isLoading) {
	Ext.getCmp('main_panel').setLoading(isLoading);
};

Exi.prototype.setError = function(error) {
	this.mainStatusBar.showError(error);
};

Exi.prototype.setLoading = function(isLoading) {
	if ((isLoading == null) || (isLoading  == true)){
		this.mainStatusBar.showBusy();
	}
	else{
		this.mainStatusBar.showReady();
	}
};

Exi.prototype.getHeader = function(error) {
	return '<img class="titleImage" src="images/logo_EMBL.png"><span class="title">Extended ISPyB</span>';
};

Exi.prototype.show = function() {
	var _this = this;
	Ext.application({
				name : 'ExiSAXS',
				launch : function() {
					Ext.create(
									'Ext.container.Viewport',
									{
										layout : 'border',
										items : [
												{
													region : 'north',
													xtype : 'component',
													padding : 10,
													height : 75,
													html : _this.getHeader(),
													cls : _this.headerCssClass

												}, {
													region : 'north',
													cls : 'toolbarPanel',
													id : 'mainMenu',
													xtype : 'panel',
													width : 400,
													items : _this.mainMenu.getPanel() },

												{
													xtype : 'panel',
													id : 'navigation',
													region : 'west',
													width : 250,
													split : false,
													title : 'Browse by',
													cls : 'navigation',
													collapsible : true,
													collapsed : true
													

												},
//												{
//													xtype : 'panel',
//													id : 'workspace',
//													region : 'east',
//													width : 250,
//													collapsed : true,
//													title : 'Workspace',
//													split : false,
//													layout : 'fit',
////													title : 'Browse by',
//													cls : 'navigation',
//													collapsible : true,
//													items : [_this.workspacePanel.getPanel()]
//
//												},
												{
													region : 'center',
													id : 'main_panel',
													xtype : 'tabpanel',
													cls : 'navigation',
													plain : true,
													items : []
												},
												{
														region : 'south',
														xtype : 'panel',
														cls : 'statusBar',
														bbar : _this.mainStatusBar.getBar() 
												}
													],
										listeners : {
											afterrender : function(component, eOpts) {
														_this.mainMenu.populateCredentialsMenu();
														_this.onAfterRender.notify();
														
//														/** If there is a user login then we show the menu **/
														if (_this.credentialManager.getCredentials() == 0){
															_this.setAnonymousMenu();
														}
														else{
															_this.setUserMenu();
															_this.mainMenu.populateCredentialsMenu();
														}
											} } });
				}

			});
};


function ExiMX() {
	 Exi.call(this, {
		 					menu: new MXMainMenu(),
		 					anonymousMenu: new MainMenu(),
		 					controllers : [new MXExiController(),new SAXSExiController(), new OfflineExiController(), new ProposalExiController(), new LabContactExiController()],
		 					headerCssClass : 'mxTitlePanel'

	 });
}

ExiMX.prototype.loadSelected = Exi.prototype.loadSelected;
ExiMX.prototype.addMainPanel = Exi.prototype.addMainPanel;
ExiMX.prototype.getSelectedDataCollections = Exi.prototype.getSelectedDataCollections;
ExiMX.prototype.addNavigationPanel = Exi.prototype.addNavigationPanel;
ExiMX.prototype.clearNavigationPanel = Exi.prototype.clearNavigationPanel;
ExiMX.prototype.clearMainPanel = Exi.prototype.clearMainPanel;
ExiMX.prototype.setLoadingNavigationPanel = Exi.prototype.setLoadingNavigationPanel;
ExiMX.prototype.setLoadingMainPanel = Exi.prototype.setLoadingMainPanel;
ExiMX.prototype.setError = Exi.prototype.setError;
ExiMX.prototype.setLoading = Exi.prototype.setLoading;
ExiMX.prototype.setLoadingMainPanel = Exi.prototype.setLoadingMainPanel;
ExiMX.prototype.show = Exi.prototype.show;
ExiMX.prototype.setAnonymousMenu = Exi.prototype.setAnonymousMenu;
ExiMX.prototype.setUserMenu = Exi.prototype.setUserMenu;
ExiMX.prototype.appendDataAdapterParameters = Exi.prototype.appendDataAdapterParameters;



ExiMX.prototype.getHeader = function(){
	return '<img class="titleImage" src="../images/logo_EMBL.png"><span class="title">ExiMX</span><span class="subtitle">Extended ISPyB for MX<sub style="font-size:10px;color:orange">BETA</sub></span>';
};

ExiMX.prototype.getDataAdapter = function(args){
	return new MxDataAdapterFactory(this.appendDataAdapterParameters(args));
};


function ExiSAXS() {
	 Exi.call(this, {
		 					menu: new SAXSMainMenu(),
		 					anonymousMenu: new MainMenu(),
		 					controllers : [new SAXSExiController(), new MXExiController(), new OfflineExiController(), new ProposalExiController(), new LabContactExiController()]
	 });
}

ExiSAXS.prototype.loadSelected = Exi.prototype.loadSelected;
ExiSAXS.prototype.addMainPanel = Exi.prototype.addMainPanel;
ExiSAXS.prototype.getSelectedDataCollections = Exi.prototype.getSelectedDataCollections;
ExiSAXS.prototype.addNavigationPanel = Exi.prototype.addNavigationPanel;
ExiSAXS.prototype.clearNavigationPanel = Exi.prototype.clearNavigationPanel;
ExiSAXS.prototype.clearMainPanel = Exi.prototype.clearMainPanel;
ExiSAXS.prototype.setLoadingNavigationPanel = Exi.prototype.setLoadingNavigationPanel;
ExiSAXS.prototype.setLoadingMainPanel = Exi.prototype.setLoadingMainPanel;
ExiSAXS.prototype.setError = Exi.prototype.setError;
ExiSAXS.prototype.setLoading = Exi.prototype.setLoading;
ExiSAXS.prototype.setLoadingMainPanel = Exi.prototype.setLoadingMainPanel;
ExiSAXS.prototype.show = Exi.prototype.show;
ExiSAXS.prototype.setAnonymousMenu = Exi.prototype.setAnonymousMenu;
ExiSAXS.prototype.setUserMenu = Exi.prototype.setUserMenu;
ExiSAXS.prototype.appendDataAdapterParameters = Exi.prototype.appendDataAdapterParameters;

ExiSAXS.prototype.getHeader = function(){
	return '<img class="titleImage" src="../images/logo_EMBL.png"><span class="title">ExiSAXS</span><span class="subtitle">Extended ISPyB for SAXS<sub style="font-size:10px;color:orange">BETA</sub></span>';
};

ExiSAXS.prototype.getDataAdapter = function(args){
	return new SaxsDataAdapterFactory(this.appendDataAdapterParameters(args));
};


function MainStatusBar(){
	
	
}

MainStatusBar.prototype.getBar = function(){
	this.statusBar =  Ext.create('Ext.ux.StatusBar', {
		id : 'main-status-bar',
	    text: 'Ready',
	    iconCls: 'accept',
	    busyIconCls: 'busy',
	    busyText: 'Connecting to servers...',
	    cls : 'statusBar',
		statusAlign : 'right'
	});
	return this.statusBar;
};

MainStatusBar.prototype.showBusy = function(){
	this.statusBar.showBusy();
};

MainStatusBar.prototype.showError = function(error){
	this.statusBar.clearStatus();
	this.statusBar.setStatus({
	    text: error,
	    iconCls: 'error'
	});
};

MainStatusBar.prototype.showReady = function(){
	this.statusBar.clearStatus();
	this.statusBar.setStatus({
	    text: 'Ready',
	    iconCls: 'accept'
	});
};





function MainMenu(args) {
	this.id = BUI.id();
	this.loginButtonId = 'loginButton' + this.id;
	this.cssClass = 'mainMenu';
	this.isHidden = true;
	if (args != null){
		if (args.cssClass != null){
			this.cssClass = args.cssClass;
		}
		if (args.isHidden != null){
			this.isHidden = args.isHidden;
		}
	}
}

MainMenu.prototype.getMenuItems = function() { return [];};


/**
 * If there is a credential then home tab will redirect to the welcome page (either manager or user)
 */
MainMenu.prototype.getHomeItem = function() { 
	return {
		text : this._convertToHTMLWhiteSpan("Home"),
		cls : 'ExiSAXSMenuToolBar',
		icon : '../images/icon/rsz_ic_home_black_24dp.png',
		handler : function(){
				if (EXI.credentialManager.getCredentials() != null){
					if (EXI.credentialManager.getCredentials().length > 0){
						var username = EXI.credentialManager.getCredentials()[0].username;
						var credential = EXI.credentialManager.getCredentialByUserName(EXI.credentialManager.getCredentials()[0].username);
						if (credential.isManager()){
							location.hash = "/welcome/manager/" + username + "/main";
						}
						else{
							location.hash = "/welcome/user/" + username + "/main";
						}
					}
					else{
						BUI.showError("You should sign up");
					}
				}
				else{
					BUI.showError("You should sign up");
				}
		}
	};
};

MainMenu.prototype.getShipmentItem = function() { 
	var _this = this;
	function onItemCheck(item, checked) {
		if (item.text == "Shipments") {
			location.hash = "/proposal/shipping/nav";
		}
		if (item.text == "Manage shipping addresses") {
			location.hash = "/proposal/addresses/nav";
		}
		if (item.text == "Shipment List") {
			location.hash = "/proposal/shipping/nav";
		}
	}

	function getBiosaxsMenu() {
		var _this = this;
		function onItemCheck(item, checked) {
			if (item.text == "Stock Solutions") {
				location.hash = "/saxs/stocksolution/nav";
			}
			
		}

		return Ext.create('Ext.menu.Menu', {
			items : [ 
						{
							text : 'Stock Solutions',
							icon : '../images/icon/testtube.png',
							handler : onItemCheck 
						} 
			] });
	}
	
	
	
	return {
		text : this._convertToHTMLWhiteSpan("Shipment"),
		cls : 'ExiSAXSMenuToolBar',
//		hidden : this.isHidden,
		menu : Ext.create('Ext.menu.Menu', {
			items : [ 
						{
							text : 'BioSAXS',
							icon : '../images/icon/macromolecule.png',
							menu: getBiosaxsMenu()
						}, 
						{
							text : 'Manage shipping addresses',
							icon : '../images/icon/contacts.png',
							handler : onItemCheck 
						}, 
						{
							text : 'Shipments',
							icon : '../images/icon/shipping.png',
							handler : onItemCheck 
						} 
					] })
	};

};


MainMenu.prototype.getHelpMenu = function() {
	var _this = this;
	function onItemCheck(item, checked) {
		if (item.text == "ISPyB Web services API Map") {
			window.open('/exi/documentation/ispyb-api-ws/print.html');
		}
		if (item.text == "Job list") {
			location.hash = "/tool/list";
		}
	}

	return Ext.create('Ext.menu.Menu', {
		items : [

		{
			text : 'Developer',
			checked : false,
			group : 'theme',
			menu : {       
                    items: [
                        {
                            text: 'ISPyB Web services API Map',
                            handler: onItemCheck
                        }, {
                            text: 'How to retrieve data from ISPyB?',
                            handler: onItemCheck
                        }, {
                            text: 'EXI Router',
                            handler: onItemCheck
                        }, {
                            text: 'EXI List Views Objects',
                            handler: onItemCheck
                        }, {
                            text: 'EXI Main View Objects',
                            handler: onItemCheck
                        }
                    ]
                }
		},
		"-",
		{
				text : 'About',
				checked : false,
				group : 'theme',
				handler : onItemCheck }
		] });
};

MainMenu.prototype.getAddCredentialMenu = function() {
	if (EXI.credentialManager.getCredentials() != null){
		if (EXI.credentialManager.getCredentials().length > 0){
			return {
				icon : '../images/icon/rsz_1ic_input_black_24dp.png',
				height : 30,
				text : 'Add',
				handler : function() {
						window.location.href = '#/login';
				} 
			};
		}
	}
};

MainMenu.prototype.populateCredentialsMenu = function() {
	this.credentialsMenu.removeAll();
	var credentialDisplay = "";
	if (EXI.credentialManager.getCredentials() != null) {
		for (var i = 0; i < EXI.credentialManager.getCredentials().length; i++) {
			credentialDisplay = EXI.credentialManager.getCredentials()[i].username;
			if (EXI.credentialManager.getCredentials()[i].activeProposals.length > 0) {
				for (var j = 0; j < EXI.credentialManager.getCredentials()[i].activeProposals.length; j++) {
					credentialDisplay = EXI.credentialManager.getCredentials()[i].activeProposals[j] + "@" + EXI.credentialManager.getCredentials()[i].username;
					this.credentialsMenu.add({
						text : credentialDisplay,
						icon : "../images/icon/rsz_esrflogo80.gif",
						disabled : true });
				}
			} else {
				this.credentialsMenu.add({
					text : credentialDisplay,
					icon : "../images/icon/rsz_esrflogo80.gif",
					disabled : true });
				
			}
			
			
		}
	} 
	if (EXI.credentialManager.getCredentials().length > 0){
		Ext.getCmp(this.loginButtonId).setText("<span style='color:white'>Log out <span style='font-weight:bold;'>" + credentialDisplay + " </span> </span>");
		Ext.getCmp(this.loginButtonId).setIcon("../images/rsz_logout.png");
	}
	else{
		Ext.getCmp(this.loginButtonId).setText("<span style='color:white'>Sign In</span>");
		Ext.getCmp(this.loginButtonId).setIcon("../images/rsz_login.png");
	}
	
	
};

MainMenu.prototype._convertToHTMLWhiteSpan = function(text) {
	return '<span style="color:white">' + text +'</span>';
};

MainMenu.prototype.isLoggedIn = function() {
	return (EXI.credentialManager.getCredentials().length > 0);
};


MainMenu.prototype.getLoginButton = function() {
	var icon =  "../images/rsz_login.png";
	var text =  this._convertToHTMLWhiteSpan("Sign In");
	
	if (EXI.credentialManager.getCredentials().length > 0){
		icon =  "../images/rsz_logout.png";
		text =  this._convertToHTMLWhiteSpan("log out");
	}
	
	return {
		xtype 	: 'splitbutton',
		id		: this.loginButtonId,
		text 	: text,
		cls 	: 'button_log_out',
		icon 	: icon,
		menu 	: this.credentialsMenu,
		handler : function() {
			if (EXI.credentialManager.getCredentials().length == 0){
				location.hash = "/login";
			}
			else{
				location.hash = "/logout";
			}
		} 
	};
};

MainMenu.prototype.getPanel = function() {
	var _this = this;
	
	this.credentialsMenu = new Ext.menu.Menu({
		id : _this.id + "menu",
		items : [
		         _this.getAddCredentialMenu()
         ] 
	});
	
	var items  = this.getMenuItems();
	items.push('->');
	items.push(this.getLoginButton());
	
	this.tb = Ext.create('Ext.toolbar.Toolbar', {
		cls : this.cssClass,
		listeners : {
			afterrender : function(component, eOpts) {
			} 
		},
		items : items
		}
	);
	return this.tb;
};

function MXMainMenu() {
	this.id = BUI.id();
	 MainMenu.call(this, {cssClass : 'mxMainMenu'});
}

MXMainMenu.prototype.populateCredentialsMenu = MainMenu.prototype.populateCredentialsMenu;
MXMainMenu.prototype.init = MainMenu.prototype.init;
MXMainMenu.prototype.getPanel = MainMenu.prototype.getPanel;
MXMainMenu.prototype._convertToHTMLWhiteSpan = MainMenu.prototype._convertToHTMLWhiteSpan;
MXMainMenu.prototype.getAddCredentialMenu = MainMenu.prototype.getAddCredentialMenu;
MXMainMenu.prototype.getLoginButton = MainMenu.prototype.getLoginButton;
MXMainMenu.prototype.setText = MainMenu.prototype.setText;
MXMainMenu.prototype.getHomeItem = MainMenu.prototype.getHomeItem;
MXMainMenu.prototype.getHelpMenu = MainMenu.prototype.getHelpMenu;
MXMainMenu.prototype.getShipmentItem = MainMenu.prototype.getShipmentItem;

MXMainMenu.prototype.getMenuItems = function() {
	return [
		this.getHomeItem(),
		this.getShipmentItem(),
		{
			text : this._convertToHTMLWhiteSpan("Prepare Experiment"),
			cls : 'ExiSAXSMenuToolBar',
			menu : this.getPrepareExperimentMenu() 
	    },
        {
				text : this._convertToHTMLWhiteSpan("Data Explorer"),
				cls : 'ExiSAXSMenuToolBar',
				menu : this.getDataExplorerMenu() 
		},
		{
			text : this._convertToHTMLWhiteSpan("Offline Data Analysis"),
			cls : 'ExiSAXSMenuToolBar',
			menu : this.getOnlineDataAnalisysMenu() 
		}, 
		{
			text : this._convertToHTMLWhiteSpan("Help"),
			cls : 'ExiSAXSMenuToolBar',
			menu : this.getHelpMenu() 
		}, 
		'->',
		{
			xtype : 'textfield',
			name : 'field1',
			value : '',
			emptyText : 'search by protein acronym',
			listeners : {
				specialkey : function(field, e) {
					if (e.getKey() == e.ENTER) {
						location.hash = "/mx/datacollection/protein_acronym/" + field.getValue() + "/main";
					}
				} 
			} 
		}
	];
};



MXMainMenu.prototype.getOnlineDataAnalisysMenu = function() {
	var _this = this;
	function onItemCheck(item, checked) {
		if (item.text == "Dimple") {
			location.hash = "/tool/dimple/main";
		}
		if (item.text == "Job list") {
			location.hash = "/tool/list";
		}
	}

	return Ext.create('Ext.menu.Menu', {
		items : [
//		{
//		    text: 'Radio Options',
//		    menu: {        // <-- submenu by nested config object
//		        items: [
//		            // stick any markup in a menu
//		            '<b class="menu-title">Choose a Theme</b>',
//		            {
//		                text: 'Aero Glass',
//		                checked: true,
//		                group: 'theme',
//		                checkHandler: onItemCheck
//		            }, {
//		                text: 'Vista Black',
//		                checked: false,
//		                group: 'theme',
//		                checkHandler: onItemCheck
//		            }, {
//		                text: 'Gray Theme',
//		                checked: false,
//		                group: 'theme',
//		                checkHandler: onItemCheck
//		            }, {
//		                text: 'Default Theme',
//		                checked: false,
//		                group: 'theme',
//		                checkHandler: onItemCheck
//		            }
//		        ]
//		    }
//		},
		{
			text : 'Dimple',
			checked : false,
			group : 'theme',
			handler : onItemCheck },
			"-",
			{
				text : 'Job list',
				checked : false,
				group : 'theme',
				handler : onItemCheck }
		] });
};
 

MXMainMenu.prototype.getPrepareExperimentMenu = function() {
	function onItemCheck(item, checked) {
		if (item.text == "My Crystals") {
			location.hash = "/crystal/nav";
		}
		if (item.text == "My Proteins") {
			location.hash = "/protein/nav";
		}
		if (item.text == "Puck") {
			location.hash = "/puck/nav";
		}
	}
	return Ext.create('Ext.menu.Menu', {
		items : [ 
			{
				text : 'My Crystals',
				icon : '../images/icon/macromolecule.png',
				handler : onItemCheck 
			},
			{
				text : 'My Proteins',
				icon : '../images/icon/testtube.png',
				handler : onItemCheck 
			},
			{
				text : 'Puck',
				icon : '../images/icon/testtube.png',
				handler : onItemCheck 
			}
		] 
	});
};

MXMainMenu.prototype.getDataExplorerMenu = function() {
	function onItemCheck(item, checked) {
		if (item.text == "Sessions") {
			location.hash = "/session/nav";
		}
		if (item.text == "Experiments") {
			location.hash = "/experiment/nav";
		}
	}
	return Ext.create('Ext.menu.Menu', {
		items : [ 
			{
				text : 'Sessions',
				icon : '../images/icon/sessions.png',
				handler : onItemCheck 
			}
		] 
	});
};


function SAXSMainMenu() {
	this.id = BUI.id();
	MainMenu.call(this, {isHidden : false, cssClass : 'mainMenu'});
}

SAXSMainMenu.prototype.populateCredentialsMenu = MainMenu.prototype.populateCredentialsMenu;
SAXSMainMenu.prototype.init = MainMenu.prototype.init;
SAXSMainMenu.prototype.getPanel = MainMenu.prototype.getPanel;
SAXSMainMenu.prototype._convertToHTMLWhiteSpan = MainMenu.prototype._convertToHTMLWhiteSpan;
SAXSMainMenu.prototype.getAddCredentialMenu = MainMenu.prototype.getAddCredentialMenu;
SAXSMainMenu.prototype.getLoginButton = MainMenu.prototype.getLoginButton;
SAXSMainMenu.prototype.setText = MainMenu.prototype.setText;
SAXSMainMenu.prototype.getHelpMenu = MainMenu.prototype.getHelpMenu;
SAXSMainMenu.prototype.getHomeItem = MainMenu.prototype.getHomeItem;
SAXSMainMenu.prototype.getShipmentItem = MainMenu.prototype.getShipmentItem;


SAXSMainMenu.prototype.getMenuItems = function() {
	
	
	
	return [	
    	this.getHomeItem(),
    	this.getShipmentItem(),
    	{
				text : this._convertToHTMLWhiteSpan("Prepare Experiment"),
				cls : 'ExiSAXSMenuToolBar',
				hidden : this.isHidden,
				menu : this.getPreparationMenu() 
		}, {
				text : this._convertToHTMLWhiteSpan("Data Explorer"),
				cls : 'ExiSAXSMenuToolBar',
				hidden : this.isHidden,
				menu : this.getDataExplorerMenu() 
		},
//		{
//			text : '<span style="color:white">Offline Data Analysis</span>',
//			cls : 'ExiSAXSMenuToolBar',
//			hidden : this.isHidden,
//			menu : this.getOnlineDataAnalisysMenu() 
//		}, 
		{
			text : this._convertToHTMLWhiteSpan("Help"),
			cls : 'ExiSAXSMenuToolBar',
			menu : this.getHelpMenu() 
		}, 
		'->', 
		{
			xtype : 'textfield',
			name : 'field1',
			emptyText : 'search macromolecule',
			hidden : this.isHidden,
			listeners : {
				specialkey : function(field, e) {
					if (e.getKey() == e.ENTER) {
						location.hash = "/datacollection/macromoleculeAcronym/" + field.getValue() + "/main";
					}
				} 
			} 
	}
	];
};




SAXSMainMenu.prototype.getPreparationMenu = function() {
	var _this = this;
	function onItemCheck(item, checked) {
		if (item.text == "Macromolecules") {
			location.hash = "/saxs/macromolecule/nav";
		}
		if (item.text == "Buffers") {
			location.hash = "/saxs/buffer/nav";
		}

		if (item.text == "Sample Tracking") {
			location.hash = "/saxs/shipping/nav";
		}

		if (item.text == "My Experiments") {
			location.hash = "/saxs/template/nav";
		}
	}

	return Ext.create('Ext.menu.Menu', {
		items : [ 
	          {
				text : 'Macromolecules',
				icon : '../images/icon/macromolecule.png',
				handler : onItemCheck 
			}, 
			{
				text : 'Buffers',
				icon : '../images/icon/buffer.jpg',
				handler : onItemCheck 
			}, 
//			"-", 
//			{
//				text : 'Stock Solutions',
//				icon : '../images/icon/testtube.png',
//				handler : onItemCheck 
//			}, 
//			{
//				text : 'Sample Tracking',
//				icon : '../images/icon/shipping.png',
//				menu:this.getSampleTrackingMenu()
//			}, 
			"-", 
			{
				text : 'My Experiments',
				icon : '../images/icon/edit.png',
				handler : onItemCheck 
			}

		] });
};

SAXSMainMenu.prototype.getDataExplorerMenu = function() {
	function onItemCheck(item, checked) {
		if (item.text == "Sessions") {
			location.hash = "/proposal/session/nav";
		}
		if (item.text == "Experiments") {
			location.hash = "/experiment/nav";
		}
	}
	return Ext.create('Ext.menu.Menu', {
		items : [ 
			{
				text : 'Sessions',
				icon : '../images/icon/sessions.png',
				handler : onItemCheck 
			}
		] 
	});
};

SAXSMainMenu.prototype.getDataReductionMenu = function() {
	var _this = this;
	function onItemCheck(item, checked) {
		if (item.text == "Sessions") {
			_this.onSessionClicked.notify();
		}
		if (item.text == "Subtraction") {
			location.hash = "/tool/subtraction/main";
		}
		if (item.text == "Experiments") {
			_this.onExperimentClicked.notify();
		}
	}

	return Ext.create('Ext.menu.Menu', {
		items : [ {
			text : '<span class="menuCategoryItem">SEC</span>' }, "-", {
			text : 'Background Test' }, {
			text : 'Baseline Checker' }, {
			text : 'Frame Merge' }, "-", {
			text : '<span class="menuCategoryItem">INDIVIDUAL CONCENTRATION</span>' }, "-", {
			text : 'Subtraction',
			checked : false,
			group : 'theme',
			checkHandler : onItemCheck }, {
			text : 'Average' }, "-", {
			text : '<span class="menuCategoryItem">COMBINING</span>' }, "-", {
			text : 'Merging tool' } ] });
};



SAXSMainMenu.prototype.getOnlineDataAnalisysMenu = function() {
	var _this = this;
	function onItemCheck(item, checked) {
		if (item.text == "Structure Validation") {
			location.hash = "/tool/crysol/main";
		}
		if (item.text == "Job list") {
			location.hash = "/tool/list";
		}
	}

	return Ext.create('Ext.menu.Menu', {
		items : [
		{
			text : 'Structure Validation',
			checked : false,
			group : 'theme',
			handler : onItemCheck },
			"-",
			{
				text : 'Job list',
				checked : false,
				group : 'theme',
				handler : onItemCheck }
		] });
};


/*function SelectionMenu() {

	
	
}

SelectionMenu.prototype.openViewer = function() {
	var ids = exiSAXS.localExtorage.selectedSubtractionsManager.getDataCollectionIds();
	location.hash = "/datacollection/dataCollectionId/" + ids.toString() +"/primaryviewer";
};

SelectionMenu.prototype.openMerge = function() {
	var ids = exiSAXS.localExtorage.selectedSubtractionsManager.getDataCollectionIds();
	location.hash = "/datacollection/dataCollectionId/" + ids.toString() +"/merge";
};

SelectionMenu.prototype.clear = function() {
	exiSAXS.localExtorage.selectedSubtractionsManager.clear();
	
};


SelectionMenu.prototype.getPanel = function() {
	var _this = this;
	var tb = Ext.create('Ext.toolbar.Toolbar', {
	    height : 50,
	   
	    items: [
	        {
	            xtype: 'splitbutton',
	            text : 'Actions',
	            menu: new Ext.menu.Menu({
	                items: [
	                    	{text: 'Open Viewer', handler: function(){ _this.openViewer(); }},
	                    	{text: 'Open Merging Tool', handler: function(){  _this.openMerge(); }},
	                    	"-",
	                    	{text: 'Create new Project from Selection', handler: function(){ alert("Item 2 clicked"); }},
	                    	"-",
	                    	{text: 'Discard Selection', handler: function(){_this.clear(); }}
	                    
	                    
	                ]
	            })
	        }
	    ]
	});
	return tb;
};
*/

function ExiController(){
	this.init();
}

ExiController.prototype.loadNavigationPanel = function(listView) {
	/** Cleaning up navigation panel * */
	EXI.clearNavigationPanel();
	EXI.setLoadingNavigationPanel(true);
	
	var onSuccess = function(sender, data) {
		/** Load panel * */
		EXI.addNavigationPanel(listView);
		/** Load data * */
		listView.load(data);
		EXI.setLoadingNavigationPanel(false);
	};
	
	/** Handle error * */
	var onError = function(sender, data) {
		EXI.setLoadingNavigationPanel(false);
	};
	
	/** Load data data * */
	return EXI.getDataAdapter({ onSuccess : onSuccess, onError : onError });
};

ExiController.prototype.init = function(){
	function setPageBackground() {

	}
	function notFound() {

	}

	/** Welcome Page **/
	Path.map("#/").to(function() {
		location.hash = '/welcome';
	}).enter(setPageBackground);
	
	Path.map("#/login").to(function() {
		EXI.authenticationForm.show();
	}).enter(setPageBackground);
	
	
	Path.map("#/welcome").to(function() {
		EXI.addMainPanel(new WelcomeMainView());
	}).enter(setPageBackground);
	
	Path.map("#/welcome/user/:user/main").to(function() {
		var user = this.params['user'];
		var mainView = new UserWelcomeMainView();
		EXI.addMainPanel(mainView);
		mainView.load(user);
	}).enter(setPageBackground);
	

	Path.map("#/welcome/manager/:user/main").to(function() {
		var user = this.params['user'];
		var mainView = new ManagerWelcomeMainView();
		EXI.addMainPanel(mainView);
		mainView.load(user);
	}).enter(setPageBackground);
	
	
	Path.map("#/logout").to(function() {
		EXI.credentialManager.logout();
		EXI.proposalManager.clear();
		
	}).enter(setPageBackground);
	
	// Here we set a "root route".  You may have noticed that when you landed on this
	// page you were automatically "redirected" to the "#/users" route.  The definition
	// below tells PathJS to load this route automatically if one isn't provided.
	Path.root("#/");

	// The `Path.rescue()` method takes a function as an argument, and will be called when
	// a route is activated that you have no yet defined an action for.  On this example
	// page, you'll notice there is no defined route for the "Unicorns!?" link.  Since no
	// route is defined, it calls this method instead.
	Path.rescue(notFound);
	
	
};

function LabContactExiController() {
	this.init();
}

LabContactExiController.prototype.loadNavigationPanel = ExiController.prototype.loadNavigationPanel;

LabContactExiController.prototype.setPageBackground = function() {
};

LabContactExiController.prototype.notFound = function() {
};



LabContactExiController.prototype.init = function() {
	var _this = this;

		function setPageBackground() {
			_this.setPageBackground();
		}
		function notFound() {
			_this.notFound();
		}

		function loadNavigationPanel(listView) {
			return _this.loadNavigationPanel(listView);
		}
		
		
		var listView = null;
		var adapter = null;
		
		Path.map("#/proposal/addresses/nav").to(function() {
			EXI.clearNavigationPanel();
			EXI.setLoadingNavigationPanel(true);
			listView = new AddressListView();
			listView.onSelect.attach(function(sender, selected) {
				location.hash = "/proposal/address/" + selected[0].labContactId + "/main";
			});
			
			EXI.addNavigationPanel(listView);
			adapter = loadNavigationPanel(listView);
			adapter.proposal.labcontacts.getLabContacts();
			
			/** Loading welcome page **/
			EXI.addMainPanel(new AddressWelcomeMainView());
			
		}).enter(this.setPageBackground);
		
		Path.map("#/proposal/address/:lacontactId/main").to(function() {
			var mainView = new AddressMainView();
			EXI.addMainPanel(mainView);
			mainView.load(this.params['lacontactId']);
		}).enter(this.setPageBackground);
		
};

function MXExiController() {
	this.init();
}

MXExiController.prototype.routeNavigation = function() {

	function loadNavigationPanel(listView) {
		/** Cleaning up navigation panel * */
		EXI.clearNavigationPanel();
		EXI.setLoadingNavigationPanel(true);

		var onSuccess = function(sender, data) {
			/** Load panel * */
			EXI.addNavigationPanel(listView);
			/** Load data * */
			listView.load(data);
			EXI.setLoadingNavigationPanel(false);
		};
		
		/** Handle error * */
		var onError = function(sender, data) {
			EXI.setLoadingNavigationPanel(false);
		};
		
		/** Load data data * */
		return EXI.getDataAdapter({ onSuccess : onSuccess, onError : onError });

	}
	/**
	 * Loading navigation panel
	 * 
	 * #/session/nav #/experiment/nav #/macromolecule/nav
	 * 
	 */
	
	var listView;	
	Path.map("#/:navigation/nav").to(function() {
		/** Session navigation * */
		if (this.params['navigation'] == "session") {
			EXI.clearNavigationPanel();
			EXI.setLoadingNavigationPanel(true);
			listView = new SessionListView();
			listView.onSelect.attach(function(sender, selected) {
				location.hash = "/mx/datacollection/session/" + selected[0].sessionId + "/main";
			});
			EXI.addNavigationPanel(listView);
			
			listView.load(EXI.proposalManager.getSessions());
			EXI.setLoadingNavigationPanel(false);
		}
		
		
		if (this.params['navigation'] == "crystal") {
			EXI.clearNavigationPanel();
			EXI.setLoadingNavigationPanel(true);
			listView = new CrystalListView();
			listView.onSelect.attach(function(sender, selected) {	
				location.hash = "/mx/crystal/" + selected[0].crystalId + "/main";
			});

			EXI.addNavigationPanel(listView);
			var onSuccess = function(sender, crystals) {
				listView.load(crystals);
				EXI.setLoadingNavigationPanel(false);
			};
			EXI.getDataAdapter({onSuccess : onSuccess}).mx.crystal.getCrystalsByProposalId();
		}
		
		if (this.params['navigation'] == "puck") {
			/** Loading welcome page **/
			EXI.addMainPanel(new PuckWelcomeMainView());
			EXI.clearNavigationPanel();
			EXI.setLoadingNavigationPanel(true);
			listView = new PuckListView();
			listView.onSelect.attach(function(sender, selected) {
				location.hash = "/mx/puck/" + selected[0].Container_containerId+ "/main";
			});

			EXI.addNavigationPanel(listView);
			var onSuccessProposal = function(sender, pucks) {
				listView.load(pucks);
				EXI.setLoadingNavigationPanel(false);
			};
			EXI.getDataAdapter({onSuccess : onSuccessProposal}).proposal.proposal.getDewarByProposalId();
		}
		
		
		if (this.params['navigation'] == "protein") {
			EXI.clearNavigationPanel();
			EXI.setLoadingNavigationPanel(true);
			listView = new ProteinListView();
			listView.onSelect.attach(function(sender, selected) {	
			});

			EXI.addNavigationPanel(listView);
			var onSuccessProtein = function(sender, proteins) {
				console.log(proteins);
				listView.load(proteins);
				EXI.setLoadingNavigationPanel(false);
			};
			EXI.getDataAdapter({onSuccess : onSuccessProtein}).mx.protein.getProteinByProposalId();
		}
		

	}).enter(this.setPageBackground);

	/** Loading a single session on the navigation panel * */
//	Path.map("#/session/nav/:sessionId/session").to(function() {
//		location.hash = "/datacollection/session/" + this.params['sessionId'] +"/main";
//	}).enter(this.setPageBackground);
	
	
	
	Path.map("#/autoprocintegration/datacollection/:datacollectionId/main").to(function() {
		var mainView = new AutoProcIntegrationMainView();
		
		EXI.addMainPanel(mainView);
		mainView.load(this.params['datacollectionId']);
		/** Selecting data collections from experiment * */
		mainView.onSelect.attach(function(sender, element) {
			EXI.localExtorage.selectedSubtractionsManager.append(element);
		});
		mainView.onDeselect.attach(function(sender, element) {
			EXI.localExtorage.selectedSubtractionsManager.remove(element);
		});

	}).enter(this.setPageBackground);
	
	
	Path.map("#/mx/workflow/step/:workflowStepIdList/main").to(function() {
		var mainView = new WorkflowStepMainView();
		EXI.addMainPanel(mainView);
		var onSuccess = function(sender, data){
			mainView.load(JSON.parse(data));
		};
		
		EXI.getDataAdapter({onSuccess : onSuccess}).mx.workflowstep.getWorkflowstepByIdList(this.params['workflowStepIdList']);
	}).enter(this.setPageBackground);
	
	
	Path.map("#/mx/datacollection/protein_acronym/:acronmys/main").to(function() {
		var mainView = new DataCollectionMxMainView();
		EXI.addMainPanel(mainView);
		var onSuccess = function(sender, data){
			mainView.load(data);
		};
		EXI.getDataAdapter({onSuccess : onSuccess}).mx.dataCollection.getByAcronymList(this.params['acronmys']);

	}).enter(this.setPageBackground);
	
	
	Path.map("#/mx/datacollection/session/:sessionId/main").to(function() {
		var mainView = new DataCollectionMxMainView();
		EXI.addMainPanel(mainView);
		EXI.setLoadingMainPanel(true);
		var onSuccess = function(sender, data){
			mainView.load(data);
			EXI.setLoadingMainPanel(false);
		};
		EXI.getDataAdapter({onSuccess : onSuccess}).mx.dataCollection.getDataCollectionViewBySessionId(this.params['sessionId']);

	}).enter(this.setPageBackground);
	
	Path.map("#/mx/crystal/:crystalId/main").to(function() {
		var mainView = new CrystalMainView();
		EXI.addMainPanel(mainView);
		EXI.setLoadingMainPanel(true);
		var onSuccess = function(sender, crystal){
			mainView.load(crystal);
			EXI.setLoadingMainPanel(false);
			
		};
		EXI.getDataAdapter({onSuccess : onSuccess}).mx.crystal.getCrystalById(this.params['crystalId']);

	}).enter(this.setPageBackground);
	
	
	Path.map("#/mx/puck/:containerId/main").to(function() {
		EXI.setLoadingMainPanel(true);
		var onSuccess = function(sender, puck){
			try{
				var mainView = new PuckMainView();
				EXI.addMainPanel(mainView);
				mainView.load(puck);
			}
			catch(e){
				EXI.setError(e.message);
			}
			EXI.setLoadingMainPanel(false);	
		};
		EXI.getDataAdapter({onSuccess: onSuccess}).proposal.shipping.getContainerById(this.params['containerId'],this.params['containerId'],this.params['containerId']);
		
	}).enter(this.setPageBackground);
	
	
	
	Path.map("#/mx/puck/add").to(function() {
		var mainView = new PuckMainView();
		EXI.addMainPanel(mainView);
		var emptyPuck = {"containerId":"","code":null,"containerType":"Puck","capacity":16,"beamlineLocation":null,"sampleChangerLocation":null,"containerStatus":null,"timeStamp":"Jan 15, 2016 2:29:39 PM","sampleVOs":[]};
		mainView.load(emptyPuck);
	}).enter(this.setPageBackground);
	
	

	Path.map("#/mx/datacollection/:dataCollectionId/image/:imageId/main").to(function() {
		var mainView = new ImageMainView();
		EXI.addMainPanel(mainView);
		mainView.load(this.params['imageId'], this.params['dataCollectionId']);
	}).enter(this.setPageBackground);

	Path.map("#/mx/image/:imageId/main").to(function() {
		var mainView = new ImageMainView();
		EXI.addMainPanel(mainView);
		mainView.load(this.params['imageId']);

	}).enter(this.setPageBackground);

	
};

MXExiController.prototype.setPageBackground = function() {

};

MXExiController.prototype.notFound = function() {

};


MXExiController.prototype.init = function() {
	var _this = this;

	function setPageBackground() {
		_this.setPageBackground();
	}
	function notFound() {
		_this.notFound();
	}

	this.routeNavigation();

	Path.rescue(notFound);

};

function OfflineExiController() {
	this.init();
}

OfflineExiController.prototype.setPageBackground = function() {

};

OfflineExiController.prototype.notFound = function() {

};

OfflineExiController.prototype.init = function() {
	var _this = this;

		function setPageBackground() {
			_this.setPageBackground();
		}
		function notFound() {
			_this.notFound();
		}


		Path.map("#/tool/dimple/main").to(function() {
			var mainView = new DimpleMainView();
			EXI.addMainPanel(mainView);
			mainView.load();
		}).enter(this.setPageBackground);
		
		
		Path.map("#/tool/crysol/main").to(function() {
			var mainView = new CrysolMainView();
			EXI.addMainPanel(mainView);
			mainView.load();
		}).enter(this.setPageBackground);

		Path.map("#/tool/subtraction/main").to(function() {
			var mainView = new SubtractionMainView();
			EXI.addMainPanel(mainView);
			mainView.load();
		}).enter(this.setPageBackground);
		
		Path.map("#/tool/list").to(function() {
			var project = null;
			var listView = new RunListView();
			/** When selected move to hash * */
			listView.onSelect.attach(function(sender, selected) {
				var runId = selected[0].internalId;
				var projectId = project.internalId;
				if (selected[0].tool == "Dimple"){
					location.hash = "/project/" +projectId + "/dimple/" + runId + "/main";
				}
				else{
					location.hash = "/project/" +projectId + "/run/" + runId + "/main";
				}
			});

			/** Cleaning up navigation panel * */
			EXI.clearNavigationPanel();
			EXI.setLoadingNavigationPanel(true);

			
			var onSuccess = function(sender, data) {
				project = data[0];
				/** Load panel * */
				EXI.addNavigationPanel(listView);
				/** Load data * */
				listView.load(data[0].runs.reverse());
				EXI.setLoadingNavigationPanel(false);
			};
			
			/** Handle error * */
			var onError = function(sender, data) {
				EXI.setLoadingNavigationPanel(false);
			};
			
			EXI.getDataAdapter({onSuccess : onSuccess, onError :onError}).exi.offline.getProject();
		}).enter(this.setPageBackground);
		

	Path.map("#/project/:projectId/run/:runId/main").to(function() {
		var projectId = this.params['projectId'];
		var runId = this.params['runId'];

		var onSuccess = function(sender, runs) {
			for (var i = 0; i < runs.length; i++) {
				if (runs[i].internalId == runId) {
					var main = new RunMainView();
					EXI.addMainPanel(main);
					main.load(runs[i]);
				}
			}
		};
		var onError = function(sender) {
			BUI.showError("There was an error");
		};
		
		EXI.getDataAdapter({onSuccess : onSuccess, onError :onError}).exi.offline.getRuns(projectId);
	}).enter(this.setPageBackground);


	Path.map("#/project/:projectId/dimple/:runId/main").to(function() {
		var projectId = this.params['projectId'];
		var runId = this.params['runId'];

		var onSuccess = function(sender, runs) {
			for (var i = 0; i < runs.length; i++) {
				if (runs[i].internalId == runId) {
					var main = new DimpleRunMainView();
					EXI.addMainPanel(main);
					main.load(runs[i]);
				}
			}
		};
		var onError = function(sender) {
			BUI.showError("There was an error");
		};
		
		EXI.getDataAdapter({onSuccess : onSuccess, onError :onError}).exi.offline.getRuns(projectId);
	}).enter(this.setPageBackground);
	
	Path.rescue(notFound);

};

function ProposalExiController() {
	this.init();
}

ProposalExiController.prototype.loadNavigationPanel = ExiController.prototype.loadNavigationPanel;

ProposalExiController.prototype.setPageBackground = function() {
};

ProposalExiController.prototype.notFound = function() {
};


ProposalExiController.prototype.init = function() {
	var _this = this;

		function setPageBackground() {
			_this.setPageBackground();
		}
		function notFound() {
			_this.notFound();
		}

		function loadNavigationPanel(listView) {
			return _this.loadNavigationPanel(listView);
		}
		
		var listView = null;
		var adapter = null;

		

		Path.map("#/proposal/session/nav").to(function() {
			listView = new SessionListView();
			/** When selected move to hash * */
			listView.onSelect.attach(function(sender, selected) {
				if (EXI.credentialManager.getTechniqueByBeamline(selected[0].beamlineName) == "SAXS"){
					location.hash = "/session/nav/" + selected[0].sessionId + "/session";
				}
				else{
					location.hash = "/mx/datacollection/session/" + selected[0].sessionId + "/main";
				}
				
			});
			adapter = loadNavigationPanel(listView);
			adapter.proposal.session.getSessions();
			
		}).enter(this.setPageBackground);
	

		
		Path.map("#/proposal/address/:lacontactId/main").to(function() {
			var mainView = new AddressMainView();
			EXI.addMainPanel(mainView);
			mainView.load(this.params['lacontactId']);
		}).enter(this.setPageBackground);
		

		Path.map("#/puck/:containerId/main").to(function() {
			var mainView = new PuckMainView();
			EXI.addMainPanel(mainView);
			mainView.load(this.params['containerId']);
		}).enter(this.setPageBackground);
		
};

function SAXSExiController() {
	this.init();
}

SAXSExiController.prototype.loadNavigationPanel = ExiController.prototype.loadNavigationPanel;

SAXSExiController.prototype.routeNavigation = function() {
	var _this = this;
	function loadNavigationPanel(listView) {
		return _this.loadNavigationPanel(listView);
	}

	/**
	 * Loading navigation panel
	 * 
	 * #/session/nav #/experiment/nav #/macromolecule/nav
	 * 
	 */
	Path.map("#/saxs/:navigation/nav").to(function() {
		var listView = null;
		
		if (this.params['navigation'] == "buffer") {
			EXI.clearNavigationPanel();
			EXI.setLoadingNavigationPanel(true);
			listView = new BufferListView();
			listView.onSelect.attach(function(sender, selected) {
				location.hash = "/buffer/" + selected[0].bufferId + "/main";
			});
			EXI.addNavigationPanel(listView);
			listView.load(EXI.proposalManager.getBuffers());
			EXI.setLoadingNavigationPanel(false);
			
			/** Loading welcome page **/
			EXI.addMainPanel(new BufferWelcomeMainView());
			
		}
		
		if (this.params['navigation'] == "stocksolution") {
			EXI.clearNavigationPanel();
			EXI.setLoadingNavigationPanel(true);
			listView = new StockSolutionListView();
			listView.onSelect.attach(function(sender, selected) {
				location.hash = "/stocksolution/" + selected[0].stockSolutionId + "/main";
			});
			EXI.addNavigationPanel(listView);
			listView.load(EXI.proposalManager.getStockSolutions());
			EXI.setLoadingNavigationPanel(false);
			
			/** Loading welcome page **/
			EXI.addMainPanel(new StockSolutionWelcomeMainView());
			
		}
		
		if (this.params['navigation'] == "macromolecule") {
			EXI.clearNavigationPanel();
			EXI.setLoadingNavigationPanel(true);
			listView = new MacromoleculeListView();
			listView.onSelect.attach(function(sender, selected) {
				location.hash = "/macromolecule/" + selected[0].macromoleculeId + "/main";
			});
			EXI.addNavigationPanel(listView);
			listView.load(EXI.proposalManager.getMacromolecules());
			EXI.setLoadingNavigationPanel(false);
			
			/** Loading welcome page **/
			EXI.addMainPanel(new MacromoleculeWelcomeMainView());
			
		}
		
		if (this.params['navigation'] == "template") {
			EXI.clearNavigationPanel();
			EXI.setLoadingNavigationPanel(true);
			
			listView = new TemplateListView();
			/** When selected move to hash * */
			listView.onSelect.attach(function(sender, selected) {
				location.hash = "/experiment/templateId/" + selected[0].experimentId + "/main";
			});
			var adapter = loadNavigationPanel(listView);
			adapter.saxs.experiment.getByExperimentByKey("experimentType", "TEMPLATE");
			
			/** Loading welcome page **/
			EXI.addMainPanel(new ExperimentWelcomeMainView());
		}


	}).enter(this.setPageBackground);

	/** Loading a single session on the navigation panel * */
	Path.map("#/session/nav/:sessionId/session").to(function() {
		
		var listView = new ExperimentListView();
		
		/** When selected move to hash * */
		listView.onSelect.attach(function(sender, selected) {
			if (selected[0].experimentType == "HPLC"){
				location.hash = "/experiment/hplc/" + selected[0].experimentId + "/main";
			}
			if ((selected[0].experimentType == "STATIC")||(selected[0].experimentType == "CALIBRATION")){
				location.hash = "/experiment/experimentId/" + selected[0].experimentId + "/main";
			}
			if (selected[0].experimentType == "TEMPLATE"){
				location.hash = "/experiment/templateId/" + selected[0].experimentId + "/main";
			}
		});
		loadNavigationPanel(listView).saxs.experiment.getExperimentsBySessionId(this.params['sessionId']);

	}).enter(this.setPageBackground);
};

SAXSExiController.prototype.setPageBackground = function() {

};

SAXSExiController.prototype.notFound = function() {

};

SAXSExiController.prototype.routeExperiment = function() {
	Path.map("#/experiment/experimentId/:experimentId/main").to(function() {
		var mainView = new ExperimentMainView();
		EXI.addMainPanel(mainView);
		mainView.load(this.params['experimentId']);
		/** Selecting data collections from experiment * */
		mainView.onSelect.attach(function(sender, element) {
			EXI.localExtorage.selectedSubtractionsManager.append(element);
		});
		mainView.onDeselect.attach(function(sender, element) {
			EXI.localExtorage.selectedSubtractionsManager.remove(element);
		});

	}).enter(this.setPageBackground);
	
	Path.map("#/experiment/hplc/:experimentId/main").to(function() {
		var mainView = new HPLCMainView();
		EXI.addMainPanel(mainView);
		mainView.load(this.params['experimentId']);
		/** Selecting data collections from experiment * */
		mainView.onSelect.attach(function(sender, element) {
			EXI.localExtorage.selectedSubtractionsManager.append(element);
		});
		mainView.onDeselect.attach(function(sender, element) {
			EXI.localExtorage.selectedSubtractionsManager.remove(element);
		});

	}).enter(this.setPageBackground);
	

	/** Loading Experiments * */
	Path.map("#/experiment/:key/:value/main").to(function() {
		EXI.setLoadingMainPanel();
		var onSuccess = function(sender, data) {
			EXI.setLoadingMainPanel(false);
			if (data != null) {
				if (data.length > 0) {
					var mainView = null;
					if (data[0].experimentType == "STATIC") {
						mainView = new ExperimentMainView();

					}
					if (data[0].experimentType == "HPLC") {
						mainView = new HPLCMainView();
					}

					if (data[0].experimentType == "TEMPLATE") {
						mainView = new TemplateMainView();
					}

					EXI.addMainPanel(mainView);
					mainView.load(data);
					/** Selecting data collections from experiment * */
					mainView.onSelect.attach(function(sender, element) {
						EXI.localExtorage.selectedSubtractionsManager.append(element);
					});
					mainView.onDeselect.attach(function(sender, element) {
						EXI.localExtorage.selectedSubtractionsManager.remove(element);
					});

				}
			}
		};
		if ((this.params['key'] == "experimentId") || (this.params['key'] == "templateId")) {
			EXI.getDataAdapter({onSuccess : onSuccess}).saxs.experiment.getByExperimentId([ this.params['value'] ]);
		} else {
			EXI.getDataAdapter({onSuccess : onSuccess}).saxs.experiment.getByExperimentByKey(this.params['key'], this.params['value']);
		}

	}).enter(this.setPageBackground);
};





SAXSExiController.prototype.routeDataCollection = function() {
	Path.map("#/datacollection/macromoleculeAcronym/:value/main").to(function() {
		/** Loading navidation menu **/
		EXI.setLoadingMainPanel("Searching " + this.params['value']+  "...");
		var onSuccess = function(sender, dataCollections) {
			if (dataCollections != null){
				if (dataCollections.length > 0){
					var mainView = new DataCollectionMainView();
					EXI.addMainPanel(mainView);
					mainView.load(dataCollections);
					/** Selecting data collections from experiment * */
					mainView.onSelect.attach(function(sender, element) {
						EXI.localExtorage.selectedSubtractionsManager.append(element);
					});
					mainView.onDeselect.attach(function(sender, element) {
						EXI.localExtorage.selectedSubtractionsManager.remove(element);
					});
					
					var listView = new DataCollectionListView();
					listView.onSelect.attach(function(sender, selected) {
						mainView.filter( selected[0].macromoleculeId, selected[0].bufferAcronym);
					});
					EXI.addNavigationPanel(listView);
					listView.load(dataCollections);
					EXI.setLoadingNavigationPanel(false);
				}
				else{
					BUI.showWarning("No macromolecule has been found");
				}
			}
			else{
				BUI.showWarning("No data to display");
			}
//			EXI.setLoadingNavigationPanel(false);
			EXI.setLoadingMainPanel(false);
		};
		EXI.getDataAdapter({onSuccess : onSuccess}).saxs.dataCollection.getDataCollectionsByKey(this.params['key'], this.params['value']);

	}).enter(this.setPageBackground);
	
	
	Path.map("#/saxs/datacollection/:key/:value/main").to(function() {
		EXI.setLoadingMainPanel();
		var onSuccess = function(sender, data) {
			var mainView = new DataCollectionMainView();
			EXI.addMainPanel(mainView);
			mainView.load(data);
			EXI.setLoadingMainPanel(false);
			/** Selecting data collections from experiment * */
			mainView.onSelect.attach(function(sender, element) {
				EXI.localExtorage.selectedSubtractionsManager.append(element);
			});
			mainView.onDeselect.attach(function(sender, element) {
				EXI.localExtorage.selectedSubtractionsManager.remove(element);
			});
		};
		EXI.getDataAdapter({onSuccess : onSuccess}).saxs.dataCollection.getDataCollectionsByKey(this.params['key'], this.params['value']);
	}).enter(this.setPageBackground);

	Path.map("#/saxs/datacollection/:key/:value/primaryviewer").to(function() {
		var onSuccess = function(sender, data) {
			var primaryMainView = new PrimaryDataMainView();
			EXI.addMainPanel(primaryMainView);
			primaryMainView.load(data);

		};
		EXI.getDataAdapter({onSuccess : onSuccess}).saxs.dataCollection.getDataCollectionsByKey(this.params['key'], this.params['value']);
	}).enter(this.setPageBackground);
	
	Path.map("#/saxs/datacollection/:key/:value/merge").to(function() {
		var onSuccess = function(sender, data) {
			var primaryMainView = new MergeMainView();
			EXI.addMainPanel(primaryMainView);
			primaryMainView.load(data);

		};
		EXI.getDataAdapter({onSuccess : onSuccess}).saxs.dataCollection.getDataCollectionsByKey(this.params['key'], this.params['value']);
	}).enter(this.setPageBackground);
};



SAXSExiController.prototype.routePrepare = function() {
	Path.map("#/buffer/:bufferId/main").to(function() {
		var mainView = new BufferMainView();
		EXI.addMainPanel(mainView);
		mainView.load(this.params['bufferId']);
	}).enter(this.setPageBackground);
	
	Path.map("#/buffer/add").to(function() {
		var mainView = new BufferMainView();
		EXI.addMainPanel(mainView);
	}).enter(this.setPageBackground);
	
	Path.map("#/macromolecule/:macromoleculeId/main").to(function() {
		var mainView = new MacromoleculeMainView();
		EXI.addMainPanel(mainView);
		mainView.load(this.params['macromoleculeId']);
	}).enter(this.setPageBackground);
	
	Path.map("#/macromolecule/add").to(function() {
		var mainView = new MacromoleculeMainView();
		EXI.addMainPanel(mainView);
	}).enter(this.setPageBackground);
	
	Path.map("#/stocksolution/:stocksolutionId/main").to(function() {
		var mainView = new StockSolutionMainView();
		EXI.addMainPanel(mainView);
		mainView.load(this.params['stocksolutionId']);
	}).enter(this.setPageBackground);
	
	Path.map("#/stocksolution/add").to(function() {
		var mainView = new StockSolutionMainView();
		EXI.addMainPanel(mainView);
		mainView.load();
	}).enter(this.setPageBackground);
	
	
	Path.map("#/prepare/stocksolution/main").to(function() {
		var mainView = new StockSolutionMainView();
		EXI.addMainPanel(mainView);
		mainView.load();
	}).enter(this.setPageBackground);
	
	

//	Path.map("#/prepare/macromolecule/main").to(function() {
//		var mainView = new MacromoleculeMainView();
//		EXI.addMainPanel(mainView);
//		mainView.load();
//	}).enter(this.setPageBackground);

	Path.map("#/prepare/templates/main").to(function() {
		var mainView = new ExperimentDesignerMainView();
		EXI.addMainPanel(mainView);
		mainView.load();
	}).enter(this.setPageBackground);
	
	Path.map("#/prepare/shipmentpreparation").to(function() {
		var mainView = new ShipmentPreparationMainView();
		EXI.addMainPanel(mainView);
		mainView.load();
	}).enter(this.setPageBackground);
	
	
	
//	Path.map("#/prepare/shipment").to(function() {
//		var _this = this;
//		var shipmentForm = new ShipmentForm({
//			creationMode : true,
//			showTitle : false
//		});
//		shipmentForm.onSaved.attach(function(sender, shipment) {
//			location.hash = "/shipping/" + shipment.shippingId + "/main";
//			window.close();
//		});
//		var window = Ext.create('Ext.window.Window', {
//			title : 'New Shipment',
//			height : 600,
//			width : 800,
//			modal : true,
//			layout : 'fit',
//			items : [ shipmentForm.getPanel() ]
//		}).show();
//	}).enter(this.setPageBackground);
	

	Path.map("#/prepare/designer").to(function() {
			var mainView = new DesignerMainView();
			EXI.addMainPanel(mainView);
			mainView.load();
//			function() {
//				var wizardWidget = new WizardWidget({
//					windowMode : true,
//					width : 1200 });
//
//				wizardWidget.onFinished.attach(function(sender, result) {
//					wizardWidget.window.close();
//					EXI.setLoading();
//					var onSuccess = (function(sender, experiment) {
//						location.hash = "/experiment/templateId/" + experiment.experimentId + "/main";
//					});
//					wizardWidget.current.setLoading("ISPyB: Creating experiment");
//					EXI.getDataAdapter({onSuccess : onSuccess}).saxs.template.saveTemplate(result.name, result.comments, result.data);
//				});
//
//				wizardWidget.draw(this.targetId, new MeasurementCreatorStepWizardForm(EXI.proposalManager.getMacromolecules(),EXI.proposalManager.getBuffers()));

			}).enter(this.setPageBackground);
};

SAXSExiController.prototype.init = function() {
	var _this = this;

	function setPageBackground() {
		_this.setPageBackground();
	}
	function notFound() {
		_this.notFound();
	}

	this.routeNavigation();
	this.routeExperiment();
	this.routeDataCollection();
	this.routePrepare();

	

	Path.map("#/project/:projectId/run/:runId/main").to(function() {
		var projectId = this.params['projectId'];
		var runId = this.params['runId'];

		var onSuccess = function(sender, runs) {
			for (var i = 0; i < runs.length; i++) {
				if (runs[i].internalId == runId) {
					var main = new RunMainView();
					EXI.addMainPanel(main);
					main.load(runs[i]);
				}
			}
		};
		
		var onError = function(sender, runs) {
			
		};
		
		EXI.getDataAdapter({onSuccess : onSuccess, onError :onError}).exi.offline.getRuns(projectId);
//		exidataAdapter.getRuns(projectId);
	}).enter(this.setPageBackground);
	

	Path.rescue(notFound);

};

function ShippingExiController() {
	this.init();
}

ShippingExiController.prototype.loadNavigationPanel = ExiController.prototype.loadNavigationPanel;

ShippingExiController.prototype.setPageBackground = function() {
};

ShippingExiController.prototype.notFound = function() {
};


ShippingExiController.prototype.loadShipmentsNavigationPanel = function(listView) {
	/** Cleaning up navigation panel * */
	EXI.clearNavigationPanel();
	EXI.setLoadingNavigationPanel(true);
	
	var onSuccess = function(sender, data) {
		data = BUI.groupBy(data, function(item){return item["Shipping_shippingId"];});
		var curated = [];
		for(var i = 0; i < data.length; i++){
			curated.push(data[i][0]);
		}
		curated.sort(function(a,b){return b.Shipping_shippingId - a.Shipping_shippingId;});
		
		/** Load panel * */
		EXI.addNavigationPanel(listView);
		/** Load data * */
		listView.load(curated);
		EXI.setLoadingNavigationPanel(false);
	};
	
	/** Handle error * */
	var onError = function(sender, data) {
		EXI.setLoadingNavigationPanel(false);
	};
	
	/** Load data data * */
	return EXI.getDataAdapter({ onSuccess : onSuccess, onError : onError });
};

ShippingExiController.prototype.init = function() {
	var _this = this;

		function setPageBackground() {
			_this.setPageBackground();
		}
		function notFound() {
			_this.notFound();
		}

		function loadNavigationPanel(listView) {
			return _this.loadNavigationPanel(listView);
		}
		
		var listView = null;
		var adapter = null;

		function loadShipmentNavigationList(){
			var listView = new ShippingListView();
			/** When selected move to hash * */
			listView.onSelect.attach(function(sender, selected) {
				location.hash = "/shipping/" + selected[0].Shipping_shippingId  + "/main";
			});
			adapter = _this.loadShipmentsNavigationPanel(listView);
			adapter.proposal.shipping.getShippings();
		}
		
		Path.map("#/proposal/shipping/nav?nomain").to(function() {
			loadShipmentNavigationList();
		});

		Path.map("#/proposal/shipping/nav").to(function() {
			loadShipmentNavigationList();
			EXI.addMainPanel(new ShippingWelcomeMainView());
		});
		
		Path.map("#/shipping/:shippingId/main").to(function() {
			var mainView = new ShippingMainView();
			EXI.addMainPanel(mainView);
			mainView.load(this.params['shippingId']);
		}).enter(this.setPageBackground);

		Path.map("#/shipping/main").to(function() {
			var mainView = new ShippingMainView();
			EXI.addMainPanel(mainView);
			mainView.load();
		}).enter(this.setPageBackground);
		
};


function Credential(username, roles, token, url, exiUrl,activeProposals, properties) {
	this.username = username.toLowerCase();
	this.roles = roles;
	this.url = url;
	this.exiUrl = exiUrl;
	this.token = token;
	this.activeProposals = activeProposals;
	this.properties = properties;
}

Credential.prototype.isManager = function() {
	return this._checkRole("manager");
};

Credential.prototype.isLocalContact = function() {
	return this._checkRole("localcontact");
};

Credential.prototype._checkRole = function(role) {
	return JSON.stringify(this.roles).toLowerCase().indexOf(role) != -1;
};

function CredentialManager(){
	this.onLogin = new Event(this);
	this.onLogout = new Event(this);
	this.onActiveProposalChanged = new Event(this);
}

CredentialManager.prototype.addCredential = function(username, roles, token, url, exiUrl, properties){
	var credential = new Credential(username, roles, token, url, exiUrl, [], properties);
	/** Writing to ExtLocalStorage * */
	if (localStorage.getItem("credentials") == null) {
		localStorage.setItem("credentials", "[]");
	}
	var credentials = this.getCredentials();
	credentials.push(credential);
	localStorage.setItem("credentials", JSON.stringify(credentials));
	this.onLogin.notify(credential);
};

CredentialManager.prototype.getCredentials = function(){
	var credentials = [];
	if (JSON.parse(localStorage.getItem("credentials")) != null){
		credentials = JSON.parse(localStorage.getItem("credentials"));
	}
	return credentials;
};

/** Given a beamline name it return MX or SAXS **/
CredentialManager.prototype.getTechniqueByBeamline = function(beamlineName){
	var connections = this.getConnections();
	for (var i = 0; i < connections.length; i++) {
		if (JSON.stringify(connections[i].beamlines.MX).toUpperCase().indexOf(beamlineName.toUpperCase()) != -1){
			return "MX";
		}
		if (JSON.stringify(connections[i].beamlines.SAXS).toUpperCase().indexOf(beamlineName.toUpperCase()) != -1){
			return "SAXS";
		}
	}
	return "UNKNOW";

};

/** Returns an string with the name of all the beamlines **/
CredentialManager.prototype.getBeamlines = function(){
	var connections = this.getConnections();
  var beamlines = [];
	for (var i = 0; i < connections.length; i++) {
      $.merge(beamlines, connections[i].beamlines.MX);
      $.merge(beamlines, connections[i].beamlines.SAXS);
	}
	return beamlines;

};

CredentialManager.prototype.getConnections = function(){
	var credentials = this.getCredentials();
	var connectors = [];
	for (var i = 0; i < credentials.length; i++) {
		if (credentials[i].activeProposals.length > 0){
			for (var j = 0; j < credentials[i].activeProposals.length; j++) {
				connectors.push({
					username : credentials[i].username,
					url : credentials[i].url,
					exiUrl : credentials[i].exiUrl,
					token : credentials[i].token,
					beamlines : credentials[i].properties.beamlines,
					proposal : credentials[i].activeProposals[j] });
			}
		}
		else{
				connectors.push({
					username : credentials[i].username,
					url : credentials[i].url,
					exiUrl : credentials[i].exiUrl,
					token : credentials[i].token,
					beamlines : credentials[i].properties.beamlines,
					proposal : null
				});
		}
	}
	return connectors;
};

CredentialManager.prototype.getCredentialByUserName = function(username, roles, token, url){
	var credentials = this.getCredentials();
	for (var i = 0; i < credentials.length; i++) {
		if (credentials[i].username == username) {
			return new Credential(
					credentials[i].username,
					credentials[i].roles,
					credentials[i].token,
					credentials[i].url,
					credentials[i].activeProposals);
		}
	}
};

CredentialManager.prototype.logout = function(username, roles, token, url){
	localStorage.removeItem('credentials');
	this.onLogout.notify();
};

CredentialManager.prototype.setActiveProposal = function(username, proposal){
	var credentials = this.getCredentials();
	for (var i = 0; i < credentials.length; i++) {
		if (credentials[i].username.toLowerCase() == username.toLowerCase()) {
			credentials[i].activeProposals = [proposal];
			localStorage.setItem("credentials", JSON.stringify(credentials));
			localStorage.removeItem("sessions");
			this.onActiveProposalChanged.notify();
		}
	}
};


BUI = {
	//interval : 60000,
	interval : 40000,
	rainbow : function(numOfSteps, step) {
		// This function generates vibrant, "evenly spaced" colours (i.e. no clustering). This is ideal for creating easily distinguishable vibrant markers in Google Maps and other apps.
		// Adam Cole, 2011-Sept-14
		// HSV to RBG adapted from: http://mjijackson.com/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript
		var r, g, b;
		var h = step / numOfSteps;
		var i = ~~(h * 6);
		var f = h * 6 - i;
		var q = 1 - f;
		switch (i % 6) {
			case 0:
				r = 1; g = f; b = 0;
				break;
			case 1:
				r = q; g = 1; b = 0;
				break;
			case 2:
				r = 0; g = 1; b = f;
				break;
			case 3:
				r = 0; g = q; b = 1;
				break;
			case 4:
				r = f; g = 0; b = 1;
				break;
			case 5:
				r = 1; g = 0; b = q;
				break;
		}
		var c = "#" + ("00" + (~~(r * 255)).toString(16)).slice(-2) + ("00" + (~~(g * 255)).toString(16)).slice(-2) + ("00" + (~~(b * 255)).toString(16)).slice(-2);
		return (c);
	},
	groupBy : function(array , f ){
		/**
		 * Groups an array based on a function
		 * Example:
		 * 		data =  this.groupBy(data, function(item){
		 * 			return [item.bufferAcronym];
		 *		});
		 * 
		 */
		  var groups = {};
		  array.forEach( function( o )
		  {
		    var group = JSON.stringify( f(o) );
		    groups[group] = groups[group] || [];
		    groups[group].push( o );  
		  });
		  return Object.keys(groups).map( function( group ){
			  return groups[group]; 
		  });
	},
		
	getFileNameByPath : function(filePath) {
		if (filePath != null){
			var split = filePath.split("/");
			if (split.length > 0){
				return split[split.length - 1];
			}
		}
		return "Not file";
	},
	getUpdateInterval : function() {
		this.interval = this.interval + 2000;
		return this.interval;
	},
	getRadiationDamageThreshold : function() {
		return 0.7;
	},
	getQualityThreshold : function() {
		return 0.7;
	},
	getCreateShipmentURL : function() {
		return '/ispyb/user/viewProjectList.do?reqCode=display&menu=create_shipment';
	},
	getCreateShipmentList : function() {
		return '/ispyb/user/viewProjectList.do?reqCode=display&menu=list_shipment';
	},
	getShippingURL : function(shippingId) {
		return '/ispyb/user/viewProjectList.do?reqCode=display&menu=shipment&shippingId=' + shippingId;
	},

	getMacromoleculeResultsURLByMultipleSearch : function(array) {
		return '/ispyb/user/viewProjectList.do?reqCode=display&menu=macromolecule&search=' +
		        JSON.stringify(array).replace(new RegExp("\"", 'g'), "'");
	},
	getMacromoleculeResultsURL : function(macromoleculeId) {
		return '/ispyb/user/viewProjectList.do?reqCode=display&menu=macromolecule&macromoleculeId=' + macromoleculeId;
	},
	getMacromoleculeBufferResultsURL : function(macromoleculeId, bufferId) {
		return '/ispyb/user/viewProjectList.do?reqCode=display&menu=macromolecule&bufferId=' + bufferId + '&macromoleculeId=' + macromoleculeId;
	},

	getMacromoleculeHeader : function(macromoleculeId) {

		function getHTMLSource(macromoleculeId) {
			if (macromoleculeId != null) {
				var html = BUI.createFormLabel("Name :", BIOSAXS.proposal.getMacromoleculeById(macromoleculeId).name, 75, 400);
				html = html + BUI.createFormLabel("Acronym :", BIOSAXS.proposal.getMacromoleculeById(macromoleculeId).acronym, 75, 400);
				if (BIOSAXS.proposal.getMacromoleculeById(macromoleculeId).comments != null) {
					html = html + BUI.createFormLabel("Comments :", BIOSAXS.proposal.getMacromoleculeById(macromoleculeId).comments, 75, 400);
				}
				return html;
			}
		}

		return Ext.create('Ext.container.Container', {
			frame : false,
			layout : 'hbox',
			title : 'Macromolecule',
			bodyPadding : '5',
			width : 890,
			margin : '0 0 10 0',
			height : 100,
			style : {
				borderColor : '#BDBDBD',
				borderStyle : 'solid',
				borderWidth : '1px'
			},
			fieldDefaults : {
				msgTarget : 'side',
				labelWidth : 100
			},
			items : [ {
				margin : "10 0 0 10",
				width : 475,
				border : 0,
				html : getHTMLSource(macromoleculeId)
			}, {
				margin : "10 0 0 10",
				width : 475,
				border : 0,
				html : BUI.getZipHTMLByMacromoleculeId(macromoleculeId)
			}
			]
		});
	},

	getZipHTMLByMacromoleculeId : function(macromoleculeId) {
		if (macromoleculeId != null) {
			var fileName = BIOSAXS.proposal.getMacromoleculeById(macromoleculeId).acronym;
			return "<div><a style='color:blue;' href='/ispyb/user/dataadapter.do?reqCode=getZipFileByMacromoleculeId&fileName=" + fileName +
				"&macromoleculeId=" + macromoleculeId + "'><img src='../images/download.png' /> Download</a></div>";
		}
	},
	getZipHTMLByExperimentId : function(experimentId, filename) {
		if (filename == null){
			filename = "experiment";
		}
		return "<div><a style='color:blue;' href='/ispyb/user/dataadapter.do?reqCode=getZipFileByExperimentId&fileName=" + filename +
		       "&experimentId=" + experimentId + "'><img src='../images/download.png' /> Download</a></div>";
	},
	
	getZipURLByAverageId : function(averageId, filename) {
		if (filename == null){
			filename = "experiment";
		}
		return "/ispyb/user/dataadapter.do?reqCode=getZipFileByAverageListId&f&mergeIdsList=" + averageId + "&fileName=" + filename;
	},
	getZipURLBySubtractionId : function(subtractionId, filename) {
		if (filename == null){
			filename = "experiment";
		}
		return "/ispyb/user/dataadapter.do?reqCode=getZipFileByAverageListId&f&subtractionIdList=" + subtractionId + "&fileName=" + filename;
	},
	
	
	getZipHTMLByFrameRangeId : function(experimentId, start, end) {
		var fileName = "experiment";
		return "<div><a style='color:blue;' href='/ispyb/user/dataadapter.do?reqCode=getZipFileH5ByFramesRange&f&experimentId=" + experimentId + 
		       "&start=" + Number(start) +"&end="+ Number(end)+"'><img src='../images/download.png' /> Download</a></div>";
	},
	getZipFrameHPLCUrl : function(experimentId, start, end) {
		return "/ispyb/user/dataadapter.do?reqCode=getZipFileH5ByFramesRange&f&experimentId=" + experimentId + "&start=" + Number(start) +"&end="+ Number(end);
	},
	
	getQueueUrl : function() {
		return "/ispyb/user/dataadapter.do?reqCode=getPagingCompactAnalysisByProposalId";
	},
	
	getQueueUrlByExperiment: function(experimentId) {
		return "/ispyb/user/dataadapter.do?reqCode=getPagingCompactAnalysisByExperimentId&f&experimentId=" + experimentId;
	},
	getStandardDeviation : function(values) {
		var sum = 0;
		var count = 0;
		var avg = null;

		var curatedValues = [];
		for ( var i = 0; i < values.length; i++) {
			var value = values[i];
			if (value != null) {
				if (!isNaN(value)) {
					count = count + 1;
					sum = sum + Number(value);
					curatedValues.push(Number(value));
				}
			}
		}

		if (count > 0) {
			avg = sum / count;
		} else {
			avg = sum;
		}
		var aux = 0;
		for ( i = 0; i < curatedValues.length; i++) {
			aux = aux + Math.pow(curatedValues[i] - avg, 2);
		}
		/** std **/
		var std = Math.sqrt(aux / count);
		return {
			std : (std),
			sum : (sum),
			avg : (avg),
			validNumber : count,
			totalNumber : values.length,
			values : values
		};
	},
	
	getHTMLTableForFrameAveraged : function(bufferAcronym, macromoleculeAcronym, bbmerges, molmerges, bamerges, totalframes, bufferId,macromoleculeId, macromoleculeColor) {
		
		function getFrameSpan(framesMerged, total) {
			return "<td style='font:normal 9px tahoma,arial,verdana,sans-serif;color:" + "black" + "'>(" + framesMerged + " of " + total + ")</td>";
		}

		function getColorFrame(framesMerged, total) {
			if (framesMerged / total < 0.5) {
				return "#FA5858";
			}
			if ((framesMerged / total >= 0.5) && (framesMerged / total < 0.8)) {
				return "#FF9900";
			}
			return "white";
		}

		function getRow(color, acroynm, framesMerged, totalframes) {
			return 	"<tr style='background-color:" +
					getColorFrame(framesMerged, totalframes) +
					";height:12px;padding:1px;'><td style=' width:10px; height:10px;'> "  +
					BUI.getRectangleColorDIV(color, 10, 10) +
					"</td> <td style='padding:5px;'> " + acroynm + "</td>" +
					getFrameSpan(framesMerged, totalframes) + "</tr>";
		}

		var html = "<table style='margin: 1,1,1,1;width:100%;font:normal 10px tahoma,arial,verdana,sans-serif;'>";

		/** Buffer Before **/
		if (bufferAcronym != null) {
			if (bbmerges != null) {
				color = BIOSAXS.proposal.bufferColors[bufferId];
				html = html + getRow(color, bufferAcronym, bbmerges, totalframes);
			}
		}

		/** Molecule **/
		if (macromoleculeAcronym != null) {
			if (molmerges != null) {
				if (macromoleculeColor == null){
					color = BIOSAXS.proposal.macromoleculeColors[macromoleculeId];
				}
				else{
					color = macromoleculeColor; //BIOSAXS.proposal.macromoleculeColors[macromoleculeId];
				}
				html = html + getRow(color, macromoleculeAcronym, molmerges, totalframes);
			}
		}

		/** Buffer After **/
		if (bufferAcronym != null) {
			if (bamerges != null) {
				color = BIOSAXS.proposal.bufferColors[bufferId];
				html = html + getRow(color, bufferAcronym, bamerges, totalframes);
			}
		}
		return html + "</table>";
	},
	isWebGLEnabled : function(return_context) {
		if (!!window.WebGLRenderingContext) {
			var canvas = document.createElement("canvas");
			names = [ "webgl", "experimental-webgl", "moz-webgl", "webkit-3d" ];
			context = false;
			for ( var i = 0; i < 4; i++) {
				try {
					context = canvas.getContext(names[i]);
					if (context && typeof context.getParameter == "function") {
						// WebGL is enabled                    
						if (return_context) {
							// return WebGL object if the function's argument is present
							return {
								name : names[i],
								gl : context
							};
						}
						// else, return just true
						return true;
					}
				} catch (e) {
				}
			}
			// WebGL is supported, but disabled
			return false;
		}
		// WebGL not supported28.    
		return false;
	},
	getHTMLTableForPrefixes : function(bufferBeforeaverageFilePath, averageFilePath, bufferAfterAverageFilePath) {

		function getRow(bufferBeforeaverageFilePath) {
			file = bufferBeforeaverageFilePath;
			try {
				file = bufferBeforeaverageFilePath.split("/")[bufferBeforeaverageFilePath.split("/").length - 1];
			} catch (e) {
				file = "NA";
			}
			return "<tr><td  style='height:12px;padding:5px;'>" + file + "</td></tr>";
		}
		var html = "<table style='margin: 1,1,1,1;width:100%;font:normal 10px tahoma,arial,verdana,sans-serif;'>";

		/** Buffer Before **/
		if (bufferBeforeaverageFilePath != null) {
			html = html + getRow(bufferBeforeaverageFilePath);
		}

		/** Molecule **/
		if (averageFilePath != null) {
			html = html + getRow(averageFilePath);
		}

		/** Buffer After **/
		if (bufferAfterAverageFilePath != null) {
			html = html + getRow(bufferAfterAverageFilePath);
		}
		return html + "</table>";
	},

	getBaseURL : function() {
		return '/ispyb/user/dataadapter.do';
	},

	getPrintcomponentURL : function(dewarId) {
		return '/ispyb/user/viewDewarAction.do?reqCode=generateLabels&dewarId=' + dewarId;

	},
	getPDBVisualizerURL : function(modelId, subtractionId, experimentId) {
		return '/ispyb/user/viewProjectList.do?reqCode=display&menu=PDBVisualizer&modelId=' + modelId + '&experimentId=' + experimentId +
			'&subtractionId=' + subtractionId;
	},

	getURL : function() {
		return this.getBaseURL() + '?reqCode=getImage';

	},
	getAbinitioImageURL : function() {
		return this.getBaseURL() + '?reqCode=getAbinitioImage';
	},
	getNSDImageURL : function(modelListId) {
		return BUI.getAbinitioImageURL() + '&type=NSD&modelListId=' + modelListId;
	},
	getCHI2ImageURL : function(modelListId) {
		return BUI.getAbinitioImageURL() + '&type=CHI2&modelListId=' + modelListId;
	},
	getModelFile : function(type, modelId, format) {
		return this.getBaseURL() + '?reqCode=getModelFile' + "&type=" + type + "&modelId=" + modelId + "&format=" + format;
	},
	getPdbURL : function() {
		return this.getBaseURL() + '?reqCode=getPdbFiles';
	},
	getStvArray : function(value, error) {
		value = Number(value);
		error = Number(error);
		return [ value - error, value, value + error ];
	},
	getPointArrayForDygraph : function(x, y, error) {
		return [ x, BUI.getStvArray(y, error) ];
	},
	createDIV : function(text, width, className, backgroundColor) {
		var nameContainer = document.createElement("div");
		var nameSpan = document.createElement("span");
		if (className != null) {
			nameSpan.setAttribute("class", className);
		}
		if (backgroundColor != null) {
			nameSpan.setAttribute("style", "float:left;width:" + width + "px;height:18px;background-color:" + backgroundColor);
		} else {
			nameSpan.setAttribute("style", "float:left;width:" + width + "px;height:18px;");
		}
		nameSpan.appendChild(document.createTextNode(text));
		nameContainer.appendChild(nameSpan);
		return nameContainer;
	},

	createFormLabel : function(labelText, text, labelWidth, textWidth, backgroundColor) {
		var div = document.createElement("div");

		div.appendChild(BUI.createDIV(labelText, labelWidth, "bLabel", backgroundColor));
		div.appendChild(BUI.createDIV(text, textWidth, "btext", backgroundColor));
		return div.innerHTML;
	},

	createTextArea : function(labelText, text, labelWidth, rows, cols) {
		var div = document.createElement("div");
		div.appendChild(BUI.createDIV(labelText, labelWidth, "bLabel"));
		var textArea = document.createElement("textarea");
		textArea.setAttribute("rows", rows);
		textArea.setAttribute("cols", cols);
		textArea.appendChild(document.createTextNode(text));
		div.appendChild(textArea);
		return div.innerHTML;
	},

	showBetaWarning : function() {
		alert("ISPyB for Biosaxs version Beta has not this functionality enabled");
	},

	formatValuesErrorUnitsScientificFormat : function(val, error, unit, args) {
		var fontSize = 14;
		var decimals = 2;
		var errorFontSize = 10;
		/** line break **/
		var lineBreak = false;
		if (args != null) {
			if (args.fontSize != null) {
				fontSize = args.fontSize;
			}
			if (args.decimals != null) {
				decimals = args.decimals;
			}
			if (args.errorFontSize != null) {
				errorFontSize = args.errorFontSize;
			}
			if (args.lineBreak != null) {
				lineBreak = args.lineBreak;
			}

		}

		if (val == "") {
			return "";
		}
		if (error == null) {
			return "<span style='font-size:" + fontSize + "px'>" + Number(val).toFixed(decimals) + "</span>";
		}
		var html = "<span style='font-size:" + fontSize + "px'>" + Number(val).toFixed(decimals) + "<span style='font-size:" + errorFontSize +
			   "px;color:gray'>  " + unit + "</span></span>";
		if (lineBreak) {
			html = html + "<br/>";
		}
		return html + "<span style='font-size:" + errorFontSize + "px'> &#177; " + Number(Number(error).toFixed(3)).toExponential() +
			      "</span></span>";
	},

	formatValuesErrorUnits : function(val, error, unit, args) {
		var fontSize = 16;
		var decimals = 2;
		var errorFontSize = 10;
		/** line break **/
		var lineBreak = true;
		if (args != null) {
			if (args.fontSize != null) {
				fontSize = args.fontSize;
			}
			if (args.decimals != null) {
				decimals = args.decimals;
			}
			if (args.errorFontSize != null) {
				errorFontSize = args.errorFontSize;
			}
			if (args.lineBreak != null) {
				lineBreak = args.lineBreak;
			}

		}

		if (val == "") {
			return "";
		}
		if (error == null) {
			return "<span style='font-size:" + fontSize + "px'>" + Number(val).toFixed(decimals) + "</span>";
		}
		var html = "<span style='font-size:" + fontSize + "px'>" + Number(val).toFixed(decimals) + "<span style='font-size:" + errorFontSize +
			   "px;color:gray'>  " + unit + "</span></span>";
		if (lineBreak) {
			html = html + "<br/>";
		}
		return html + "<span style='font-size:" + errorFontSize + "px'> &#177; " + Number(Number(error).toFixed(8)).toExponential() +
			      "</span></span>";
	},

	formatValuesUnits : function(val, unit, args) {
		var fontSize = 12;
		var decimals = 2;
		var unitsFontSize = 10;
		if (args != null) {
			if (args.fontSize != null) {
				fontSize = args.fontSize;
			}
			if (args.decimals != null) {
				decimals = args.decimals;
			}
			if (args.unitsFontSize != null) {
				unitsFontSize = args.unitsFontSize;
			}

		}

		if (val == "") {
			return "";
		}
		
		if (unit == null) {
			return "<span style='font-size:" + fontSize + "px'>" + Number(val).toFixed(decimals) + "</span>";
		}
		return "<span style='font-size:" + fontSize + "px'>" + Number(val).toFixed(decimals) + " </span><span style='font-size:" + unitsFontSize +
		       "px;color:gray'>  " + unit + "</span></span>";
	},

	getGreenButton : function(text, args) {
		var width = 70;
		var height = 20;
		if (args != null) {
			if (args.width != null) {
				width = args.width;
			}
			if (args.height != null) {
				height = args.height;
			}
		}

		return '<input type="button" name="btn" style= "font-size:9px;width:' + width + 'px; height:' + height + 'px" class="btn-green" value="' + text + '"/>';
	},
	getBlueButton : function(text, args) {
			var width = 70;
			var height = 20;
			if (args != null) {
				if (args.width != null) {
					width = args.width;
				}
				if (args.height != null) {
					height = args.height;
				}
			}

			return '<input type="button" name="btn" style= "font-size:9px;width:' + width + 'px; height:' + height + 'px" class="btn-blue" value="' + text + '"/>';
	},

	getSubmitGreenButton : function(text) {
		return '<input type="submit" type="button" name="btn" class="btn-green" value="' + text + '"/>';
	},

	getRedButton : function(text) {
		return '<input type="button"  name="btn" class="btn-red" value="' + text + '" />';

	},
	getRectangleColorDIV : function(color, height, width) {
		return '<div style="border: 1px solid gray;background-color: ' + color + '; height:' + height + 'px;width:' + width + 'px" ></div>';
	},

	openBufferWindow : function(bufferId) {
		var window = new BufferWindow();
		window.draw(tabs.experiment.getBufferById(bufferId), tabs.experiment);
	},

	/** Render for safety levels on grids **/
	safetyRenderer : function(val, y, specimen) {
		var color = val;
		if (val == "YELLOW") {
			color = "#E9AB17";
		}
		return '<span style="color:' + color + ';">' + val + '</span>';
	},

	getSampleColor : function() {
		return '#CB181D';
	},

	getLightSampleColor : function() {
		return '#FCBBA1';
	},

	getBufferColor : function() {
		return '#6A51A3';
	},
	getLightBufferColor : function() {
		return '#BCBDDC';
	},

	formatConcentration : function(val) {
		if (val != null) {
			return "<span style='font-size:16px'>" + Number(val).toFixed(2) + "</span><span style='font-size:9px'> mg/ml </span>";
		}
		return val;
	},

	formatVolume : function(sample, volume) {
		if (Number(sample.data.volumeToLoad) > Number(sample.data.volume)) {
			return "<span style='color:red;font-weight:bold;'>" + volume + "</span><span style='font-size:9;color:red;'> l</span>";
		}
		if (Number(sample.data.volumeToLoad) == Number(sample.data.volume)) {
			return "<span style='color:orange;font-weight:bold;'>" + volume + "</span><span style='font-size:9;color:orange;'> l</span>";
		}
		return "<span>" + volume + "</span><span style='font-size:9'> l</span>";
	},

	getProposal : function() {
		return new Proposal();
	},

	getSampleNameRenderer : function(val, y, record) {
		var sample = record.data;
		if (record.raw.macromolecule3VO == null) {
			return '<span style="color:blue;">' + sample.code + '</span>';
		} else {
			return '<span style="color:green;">' + sample.code + '</span>';
		}
	},

	getSafetyLevels : function() {
		var safetyLevels = [];
		safetyLevels.push({
			safetyLevelId : "",
			name : "UNKNOWN"
		});
		safetyLevels.push({
			safetyLevelId : 1,
			name : "GREEN"
		});
		safetyLevels.push({
			safetyLevelId : 2,
			name : "YELLOW"
		});
		safetyLevels.push({
			safetyLevelId : 3,
			name : "RED"
		});
		return safetyLevels;
	},

	getErrorColor : function() {
		return '#F6CED8';
	},
	getWarningColor : function() {
		return '#F5DA81';
	},
	getValidColor : function() {
		return '#E0F8E0';
	},
	getSamplePlateLetters : function() {
		return [ "A", "B", "C", "D", "E", "F", "G", "H" ];
	},
	getSamplePositionHTML : function(sample, experiment) {
		var plate = "";
		var row = "";
		var column = "";
		var rows = this.getSamplePlateLetters();
		if (sample.sampleplateposition3VO != null) {
			var samplePlate = experiment.getSamplePlateById(sample.sampleplateposition3VO.samplePlateId);
			if (samplePlate != null) {
				plate = (samplePlate.slotPositionColumn);
				row = (sample.sampleplateposition3VO.rowNumber);
				column = (sample.sampleplateposition3VO.columnNumber);
				//				   var html = "<span style='font-weight:italic'>Plate: </span>" + "<span style='font-weight:bold'>" + plate + "</span>";
				//				   html = html +  "<span style='font-weight:italic'>, Row: </span>" + "<span style='font-weight:bold'>" +  rows[row - 1] + "</span>";
				//				   html = html +  "<span style='font-weight:italic'>, Column: </span>" + "<span style='font-weight:bold'>" + column + "</span>";
				var html = "<span style='font-weight:italic'>Plate: </span><span style='font-weight:bold'>" + plate +
					   "</span>-<span style='font-weight:bold'>" + rows[row - 1] + "</span><span style='font-weight:bold'>" + column + "</span>";
				return html;
			}
		}
		return "";
	},

	getSafetyLabelName : function(safetyLevelId) {
		var safetyLevels = BUI.getSafetyLevels();
		for ( var i = 0; i < safetyLevels.length; i++) {
			if (safetyLevels[i].safetyLevelId == safetyLevelId) {
				return safetyLevels[i].name;
			}
		}
		return "UNKNOWN";
	},
	/** generate random id **/
	id : function() {
		var text = "";
		var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

		for ( var i = 0; i < 5; i++){
			text += possible.charAt(Math.floor(Math.random() * possible.length));
		}

		return "ExiSAXS" + text;
	},
	showWarning : function(message) {
		Ext.Msg.show({
			title : 'Warning',
			msg : message,
			icon : Ext.Msg.WARNING,
			animEl : 'elId'
		});
	},
	showError : function(message) {
		Ext.Msg.show({
			title : 'Warning',
			msg : message,
			icon : Ext.Msg.ERROR,
			animEl : 'elId'
		});
	},
	getTipHTML : function(message) {
		//return "<div  class='panelMacro' ><table class='tipMacro'><colgroup span='1'><col span='1' width='24'><col span='1'></colgroup><tbody><tr><td colspan='1' rowspan='1' valign='top'><img align='middle' src='https://cwiki.apache.org/confluence/images/emoticons/check.gif' width='16' height='16' alt='' border='0'></td><td colspan='1' rowspan='1'><b>Tip</b><br clear='none'>"
		//		+ message + "</td></tr></tbody></table></div>";
		return "<div  class='panelMacro' ><table class='tipMacro'><colgroup span='1'><col span='1' width='24'><col span='1'></colgroup><tbody><tr><td colspan='1' rowspan='1' valign='top'></td><td colspan='1' rowspan='1'><b>Tip</b><br clear='none'>" +
			message + "</td></tr></tbody></table></div>";
	},

	getWarningHTML : function(message) {
		return "<div class='panelMacro' ><table class='warningMacro'><colgroup span='1'><col span='1' width='24'><col span='1'></colgroup><tbody><tr><td colspan='1' rowspan='1' valign='top'></td><td colspan='1' rowspan='1'><b>Warning</b><br clear='none'>" +
			message + "</td></tr></tbody></table></div>";
	},

	getErrorHTML : function(message) {
		return "<div class='panelMacro' ><table class='errorMacro'><colgroup span='1'><col span='1' width='24'><col span='1'></colgroup><tbody><tr><td colspan='1' rowspan='1' valign='top'><img align='middle' src='https://cwiki.apache.org/confluence/images/emoticons/forbidden.gif' width='16' height='16' alt='' border='0'></td><td colspan='1' rowspan='1'><b>Error</b><br clear='none'>" +
			message + "</td></tr></tbody></table></div>";
	},

	getProgessBar : function(percentage, text) {
		/** percentage 100% green **/
		var color = "#0a0";

		color = "#99CC00";
		if (percentage > 100) {
			color = "yellow";
			percentage = 100;
		}
		if (isNaN(percentage)) {
			color = "white";
			percentage = 0;
		}

		var defaultText = percentage + "%";
		if (text != null) {
			defaultText = text;
		}

		return "<div class='meter-wrap'><div class='meter-value' style='background-color: " + color + " ; width: " + percentage +
		       "%;'><div class='meter-text'>" + defaultText + "</div></div></div>";
	},
	getFileName : function(filePath){
		if (filePath != null){
			return filePath.split("/")[filePath.split("/").length - 1];
		}
		return "";
	}

};

//
//
//
//
//Ext.define('Ext.form.field.RequiredNumber', {
//	extend : 'Ext.form.field.Number',
//	alias : 'widget.requirednumberfield',
//	alternateClassName : [ 'Ext.form.RequiredNumberField', 'Ext.form.RequiredNumber' ],
//	config : {
//		cls : 'custom-field-text-required'
//	},
//
//	initComponent : function() {
//		var me = this;
//		me.callParent();
//		me.setMinValue(me.minValue);
//		me.setMaxValue(me.maxValue);
//	},
//
//	onChange : function() {
//		if ((this.getValue() == null) || String(this.getValue()).length == 0) {
//			this.addCls('custom-field-text-required');
//		} else {
//			this.removeCls('custom-field-text-required');
//		}
//		this.toggleSpinners();
//		this.callParent(arguments);
//	}
//});
//
//
//Ext.define('Ext.form.field.RequiredText', {
//	extend : 'Ext.form.field.Text',
//	alias : 'widget.requiredtext',
//	requires : [ 'Ext.form.field.VTypes', 'Ext.layout.component.field.Text' ],
//	alternateClassName : [ 'Ext.form.RequiredTextField', 'Ext.form.RequiredText' ],
//	config : {
//		cls : 'custom-field-text-required'
//	},
//	initComponent : function() {
//		var me = this;
//		if (me.allowOnlyWhitespace === false) {
//			me.allowBlank = false;
//		}
//		me.callParent();
//		me.addEvents(
//		/**
//		 * @event autosize
//		 * Fires when the **{@link #autoSize}** function is triggered and the field is resized according to the
//		 * {@link #grow}/{@link #growMin}/{@link #growMax} configs as a result. This event provides a hook for the
//		 * developer to apply additional logic at runtime to resize the field if needed.
//		 * @param {Ext.form.field.Text} this This text field
//		 * @param {Number} width The new field width
//		 */
//		'autosize',
//
//		/**
//		 * @event keydown
//		 * Keydown input field event. This event only fires if **{@link #enableKeyEvents}** is set to true.
//		 * @param {Ext.form.field.Text} this This text field
//		 * @param {Ext.EventObject} e
//		 */
//		'keydown',
//		/**
//		 * @event keyup
//		 * Keyup input field event. This event only fires if **{@link #enableKeyEvents}** is set to true.
//		 * @param {Ext.form.field.Text} this This text field
//		 * @param {Ext.EventObject} e
//		 */
//		'keyup',
//		/**
//		 * @event keypress
//		 * Keypress input field event. This event only fires if **{@link #enableKeyEvents}** is set to true.
//		 * @param {Ext.form.field.Text} this This text field
//		 * @param {Ext.EventObject} e
//		 */
//		'keypress');
//		me.addStateEvents('change');
//		me.setGrowSizePolicy();
//	},
//	checkChange : function() {
//		if ((this.getValue() == null) || String(this.getValue()).length == 0) {
//			this.addCls('custom-field-text-required');
//		} else {
//			this.removeCls('custom-field-text-required');
//		}
//	}
//});







var BIOSAXS_COMBOMANAGER = {
	getComboProposal : function(args) {
		var labelWidth = null;
		var width = 400;
		
		var id ='proposalIdCombo';
		if (args != null){
			if (args.labelWidth != null){
				labelWidth = args.labelWidth;
			}
			if (args.width != null){
				width = args.width;
			}
			if (args.id != null){
				id = args.id;
			}
		}
		var proposalStore = Ext.create('Ext.data.Store', {
			fields : [ 'code', 'number', 'title', 'proposalId', 'proposal' ],
			data : EXI.proposalManager.getProposals() });

		return Ext.create('Ext.form.ComboBox', {
			fieldLabel : 'Proposal',
			id : id,
			width : width,
			store : proposalStore,
			labelWidth : labelWidth,
			queryMode : 'local',
			displayField : 'proposal',
			valueField : 'proposalId' 
		});
	},
	
	getComboMacromoleculeByMacromolecules : function(macromolecules, args) {
		var labelWidth = 150;
		var margin = "0 0 5 0";
		var width = 300;

		if (args != null) {
			if (args.labelWidth != null) {
				labelWidth = args.labelWidth;
			}
			if (args.margin != null) {
				margin = args.margin;
			}
			if (args.width != null) {
				width = args.width;
			}
		}

		var store = Ext.create('Ext.data.Store', {
			fields : [ 'macromoleculeId', 'acronym' ],
			data : macromolecules,
			sorters : [ 'acronym' ]
		});

		return Ext.create('Ext.form.ComboBox', {
			fieldLabel : 'Macromolecules',
			labelWidth : labelWidth,
			width : width,
			margin : margin,
			store : store,
			editable: false,
			queryMode : 'local',
			displayField : 'acronym',
			valueField : 'macromoleculeId'
		});
	},
	getComboBuffers : function(buffers, args) {
		var labelWidth = 150;
		var margin = "0 0 5 0";
		var width = 300;
		var fieldLabel = 'Buffer';

		if (args != null) {
			if (args.labelWidth != null) {
				labelWidth = args.labelWidth;
			}
			if (args.margin != null) {
				margin = args.margin;
			}
			if (args.width != null) {
				width = args.width;
			}
			if (args.noLabel != null) {
				fieldLabel = null;
			}
		}

		var store = Ext.create('Ext.data.Store', {
			fields : [ 'bufferId', 'acronym' ],
			data : buffers,
			sorters : [ 'acronym' ]
		});

		return Ext.create('Ext.form.ComboBox', {
			fieldLabel : fieldLabel,
			labelWidth : labelWidth,
			width : width,
			margin : margin,
			editable: false,
			store : store,
			queryMode : 'local',
			displayField : 'acronym',
			valueField : 'bufferId'
		});
	},
	getComboSessions : function(sessions, args) {
		var labelWidth = 150;
		var margin = "0 0 5 0";
		var width = 300;

		if (args != null) {
			if (args.labelWidth != null) {
				labelWidth = args.labelWidth;
			}
			if (args.margin != null) {
				margin = args.margin;
			}
			if (args.width != null) {
				width = args.width;
			}
		}

		for ( var i = 0; i < sessions.length; i++) {
			sessions[i]["startDateFormatted"] = moment(sessions[i].startDate).format("DD/MM/YYYY");
			sessions[i]["sorter"] = moment(sessions[i].startDate).format("YYYYMMDD");
		}

		var store = Ext.create('Ext.data.Store', {
			fields : [ 'sessionId', 'startDateFormatted', 'beamlineName', 'startDate', 'endDate', 'beamlineOperator' ],
			data : sessions,
			sorters : [ 'sorter' ]
		});

		return Ext.create('Ext.form.ComboBox', {
			fieldLabel : 'Session',
			labelWidth : labelWidth,
			width : width,
			margin : margin,
			store : store,
			queryMode : 'local',
			valueField : 'sessionId',
			// Template for the dropdown menu.
			// Note the use of "x-boundlist-item" class,
			// this is required to make the items selectable.
			tpl : Ext.create('Ext.XTemplate', '<tpl for=".">',
					'<div class="x-boundlist-item">{startDateFormatted}<span style="font-weight:bold"> {beamlineName}</span></div>', '</tpl>'),
			// template for the content inside text field
			displayTpl : Ext.create('Ext.XTemplate', '<tpl for=".">', '{startDateFormatted} {beamlineName}', '</tpl>')

		});
	},
	getComboStorageTemperature : function(args) {
		var labelWidth = 200;
		var width = 500;

		if (args != null) {
			if (args.labelWidth != null) {
				labelWidth = args.labelWidth;
			}
			if (args.width != null) {
				width = args.width;
			}
		}
		
		var storageLocations = Ext.create('Ext.data.Store', {
		    fields: ['value', 'name'],
		    data : [
		        {"value":"N/A", "name":"N/A"},
		        {"value":"-80", "name":"-80"},
		        {"value":"-20", "name":"-20"},
		        {"value":"+4", "name":"+4"},
		        {"value":"Room Temperature", "name":"Room Temperature"}
		    ]
		});
		this.storageLocationComboBox = Ext.create('Ext.form.ComboBox', {
		    fieldLabel: 'Storage Condition',
		    store: storageLocations,
		    queryMode: 'local',
		    labelWidth : labelWidth,
		    width : width,
		    displayField: 'name',
		    valueField: 'value',
		    value : 'Not set'
		});
		return this.storageLocationComboBox;
	},
	getComboPuckType : function(args) {
		var labelWidth = 200;
		var width = 500;
		var margin = null;
		
		if (args != null) {
			if (args.labelWidth != null) {
				labelWidth = args.labelWidth;
			}
			if (args.width != null) {
				width = args.width;
			}
			if (args.margin != null) {
				margin = args.margin;
			}
		}
		
		var storageLocations = Ext.create('Ext.data.Store', {
		    fields: ['value', 'name'],
		    data : [
		        {"value":10, "name":"SPINE"},
		        {"value":16, "name":"UNIPUCK"},
		        {"value":96, "name":"PLATE"}
		    ]
		});
		this.storageLocationComboBox = Ext.create('Ext.form.ComboBox', {
		    fieldLabel: 'Type',
		    store: storageLocations,
		    queryMode: 'local',
		    labelWidth : labelWidth,
		    width : width,
		    margin : margin,
		    displayField: 'name',
		    valueField: 'value',
		    value : 'Not set'
		});
		return this.storageLocationComboBox;
	}
};
var MX_COMBOMANAGER = {
		getComboProteins : function(proteins, args) {
			var labelWidth = 150;
			var margin = "10 10 10 40";
			var width = 300;

			if (args != null) {
				if (args.labelWidth != null) {
					labelWidth = args.labelWidth;
				}
				if (args.margin != null) {
					margin = args.margin;
				}
				if (args.width != null) {
					width = args.width;
				}
			}
			
			var store = Ext.create('Ext.data.Store', {
				fields : [ 'name', 'acronym' ],
				data : proteins,
				sorters : [ 'acronym' ]
			});

			return Ext.create('Ext.form.ComboBox', {
				fieldLabel : 'Proteins',
				labelWidth : labelWidth,
				width : width,
				margin : margin,
				store : store,
				editable: false,
				queryMode : 'local',
				displayField : 'acronym',
				valueField : 'proteinId'
			});

		}
		
	};



/**
 * Using dygraph it plots a chart. Params: targetId, labelsContainerId, args
 * 
 * @width
 * @height
 * @labelsWidth
 * @targetId
 * @customBars
 * @ylabel
 * @xlabel
 * @showRangeSelector Show or hide the range selector widget.
 */
function DygraphWidget(targetId, args) {
	this.width = 1000;
	this.height = 600;
	this.labelsWidth = 100;
	this.targetId = targetId;
	this.customBars = false;
	this.ylabel = "";
	this.xlabel = "";
	this.id = BUI.id();
	this.showRangeSelector = false;
	this.interactionModel = null;
	this.labelsDivStyles = null;

	this.ranges = [
//	               {
//		start : 100,
//		end : 200,
//		color : 'rgb(150,200,255)'
//	}
	               ];

	if (args != null) {
		if (args.width != null) {
			this.width = args.width;
		}
		if (args.height != null) {
			this.height = args.height;
		}

		if (args.labelsWidth != null) {
			this.labelsWidth = args.labelsWidth;
		}
		if (args.labelsDivStyles != null) {
			this.labelsDivStyles = args.labelsDivStyles;
		}
		if (args.customBars != null) {
			this.customBars = args.customBars;
		}
		if (args.ylabel != null) {
			this.ylabel = args.ylabel;
		}
		if (args.xlabel != null) {
			this.xlabel = args.xlabel;
		}
		if (args.showRangeSelector != null) {
			this.showRangeSelector = args.showRangeSelector;
		}
		if (args.interactionModel != null) {
			this.interactionModel = args.interactionModel;
		}

		if (args.scaled != null) {
			this.scaled = args.scaled;
		}
		if (args.ranges != null) {
			this.ranges = args.ranges;
		}

	}

	this.onZoomX = new Event(this);
	this.onResetZoom = new Event(this);
	this.dblclick = new Event(this);
}

/** Draws it on targetId 
 * data: dygraphs.com/data.html
 * 
 * **/

DygraphWidget.prototype.dblclick = function(event, g, context) {
	g.widget.dblclick.notify({
		x : g.lastx_ });
};

DygraphWidget.prototype._createHTLMWrapper = function(data, colors, labels) {
	/** If plot is set in a tab it is possible that it is not renderer yet **/
	if (document.getElementById(this.targetId) == null) {
		return;
	}
	document.getElementById(this.targetId).innerHTML = "";
	/** Creating legend in a table **/
	var table = document.createElement("table");
	var tr = document.createElement("tr");
	var tdCanvas = document.createElement("td");

	this.canvasDiv = document.createElement("div");
	this.canvasDiv.setAttribute("id", "dygraph_canvas_" + this.id);
	this.canvasDiv.setAttribute("style", "width:" + this.width + "px;height:" + this.height + "px");
	tdCanvas.appendChild(this.canvasDiv);

	this.legendDiv = document.createElement("div");
	tr.appendChild(tdCanvas);
	table.appendChild(tr);
	document.getElementById(this.targetId).appendChild(table);
};

DygraphWidget.prototype.draw = function(data, colors, labels) {
	var _this = this;
	this._createHTLMWrapper(data, colors, labels);
	this.dygraph = new Dygraph(this.canvasDiv, data, {
		labels : labels,
		labelsDiv : this.legendDiv,
		labelsSeparateLines : true,
		highlightCircleSize : 3,
		strokeWidth : 1,
		customBars : this.customBars,
		colors : colors,
		//		scaled : this.scaled,
		//		ranges : this.ranges,
		xlabel : this.xlabel,
		ylabel : this.ylabel,
		showRangeSelector : this.showRangeSelector,
		rangeSelectorPlotStrokeColor : 'rgba(50,50,50,0.3)',
		rangeSelectorPlotFillColor : 'rgba(50,50,50,0.1)',
		labelsDivStyles : this.labelsDivStyles,
		interactionModel : this.interactionModel,
		underlayCallback : function(canvas, area, g) {
			if (_this.ranges != null) {
				for ( var key in _this.ranges) {
					var bottom_left = g.toDomCoords(_this.ranges[key].start, -20);
					var top_right = g.toDomCoords(_this.ranges[key].end, +20);

					var left = bottom_left[0];
					var right = top_right[0];

					canvas.fillStyle = _this.ranges[key].color;
					canvas.fillRect(left, area.y, right - left, area.h);

				}
			}

		} });

};



function StdDevDyGraph(targetId, args) {
	this.scaled = false;
	if (args == null) {
		args = {};
	}
	args.customBars = true;
	DygraphWidget.prototype.constructor.call(this, targetId, args);
}

StdDevDyGraph.prototype.dblclick = DygraphWidget.prototype.dblclick;
StdDevDyGraph.prototype._createHTLMWrapper = DygraphWidget.prototype._createHTLMWrapper;
StdDevDyGraph.prototype.draw = DygraphWidget.prototype.draw;

StdDevDyGraph.prototype.input = function() {
	return {
		data : [ [ 1, [ 2, 3, 3.5 ], [ 4, 4.2, 5 ] ], [ 2, [ 5, 5.5, 5.7 ], [ 4, 4.2, 5 ] ] ],
		colors : [ "blue", "red" ],
		labels : [ "", 'data1', 'data2' ] };
};

StdDevDyGraph.prototype.test = function(targetId) {
	var dygraphObject = new StdDevDyGraph(targetId, {
		width : 500,
		height : 400,
		xlabel : "xLabel",
		showRangeSelector : false });

	dygraphObject.draw(dygraphObject.input().data, dygraphObject.input().colors, dygraphObject.input().labels);
};

/*
 * var Event = function (sender) { this._sender = sender; this._listeners = []; };
 */

function Event(sender) {
	this._sender = sender;
	this._listeners = [];
}

Event.prototype = {
	attach : function(listener) {
		this._listeners.push(listener);
	},
	notify : function(args) {
		for (var i = 0; i < this._listeners.length; i++) {
			this._listeners[i](this._sender, args);
		}
	}
};


function ProgressBar(){}

ProgressBar.prototype.getPanel = function(done, total){
	var percentage = (parseFloat(done)/parseFloat(total))*100;
	
	var color = '#337ab7';
	
	if (percentage == 100){
		color = 'green';
	}
	
	if (percentage < 50){
		color = 'orange';
	}
	return "<div class='progress'><div class='progress-bar' role='progressbar' aria-valuenow='10' aria-valuemin='0' aria-valuemax='100' style='background-color:"+ color + ";width:" + percentage + "%'></div></div>";
	
};
/** Function for String **/
String.prototype.format = function (args) {
	var str = this;
	return str.replace(String.prototype.format.regex, function(item) {
		var intVal = parseInt(item.substring(1, item.length - 1));
		var replace;
		if (intVal >= 0) {
			replace = args[intVal];
		} else if (intVal === -1) {
			replace = "{";
		} else if (intVal === -2) {
			replace = "}";
		} else {
			replace = "";
		}
		return replace;
	});
};
String.prototype.format.regex = new RegExp("{-?[0-9]+}", "g");
